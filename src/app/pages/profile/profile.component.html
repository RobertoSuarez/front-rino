<p-toast></p-toast>
<div class="grid grid-cols-12 gap-4 md:gap-8">
    <div class="col-span-12">
        <div class="profile-modern-header card mb-0">
            <div class="profile-modern-header__copy">
                <h1>Mi Perfil</h1>
                <p>Gestiona tu información personal y visualiza tu progreso en el imperio.</p>
            </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="loading" class="card">
            <div class="flex justify-content-center align-items-center min-h-[300px] md:min-h-[400px]">
                <div class="text-center">
                    <p-progressSpinner strokeWidth="3" animationDuration="1s"></p-progressSpinner>
                    <p class="text-600 mt-3 text-sm md:text-base">Cargando información del perfil...</p>
                </div>
            </div>
        </div>

        <!-- Error State -->
        @if(error && !loading) {
        <div class="card">
            <div class="flex align-items-center justify-content-center p-4 md:p-6 border-round-lg"
                style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 1px solid #f87171;">
                <div class="text-center">
                    <i class="pi pi-exclamation-triangle text-red-500 text-3xl md:text-4xl mb-3"></i>
                    <h4 class="text-red-800 m-0 mb-2 text-lg md:text-xl">Error al cargar el perfil</h4>
                    <p class="text-red-600 m-0 text-sm md:text-base">{{ error }}</p>
                </div>
            </div>
        </div>
        }

        <!-- Modo visualización -->
        @if (profileData && !loading && !editMode) {
        <div class="profile-modern-grid">
            <section class="profile-card-main card">
                <div class="profile-card-main__head">
                    <div class="profile-avatar-wrap">
                        <img [src]="profileData.urlAvatar" alt="Avatar de usuario">
                        <span class="profile-online-dot"></span>
                    </div>
                    <div class="profile-main-identity">
                        <span class="profile-progress-chip">{{ getProfileCompletion() }}%</span>
                        <h2>{{ profileData.firstName }} {{ profileData.lastName }}</h2>
                        <p>{{ profileData.email }}</p>
                        <p-tag [value]="getUserTypeLabel(profileData.typeUser)"
                            [severity]="getUserTypeColor(profileData.typeUser)" icon="pi pi-user">
                        </p-tag>
                    </div>
                </div>

                <div class="profile-meta-grid">
                    <div class="profile-meta-item">
                        <i class="pi pi-calendar text-primary"></i>
                        <div>
                            <span>Miembro desde</span>
                            <strong>{{ formatDateShort(profileData.createdAt) }}</strong>
                        </div>
                    </div>
                    <div class="profile-meta-item" *ngIf="profileData.birthday">
                        <i class="pi pi-gift text-pink-500"></i>
                        <div>
                            <span>Cumpleaños</span>
                            <strong>{{ formatDateShort(profileData.birthday) }}</strong>
                        </div>
                    </div>
                </div>

                <div class="profile-achievements">
                    <h4>Logros Recientes</h4>
                    <div class="profile-achievements__list">
                        <span class="achievement-item achievement-item--gold"><i class="pi pi-trophy"></i></span>
                        <span class="achievement-item achievement-item--blue"><i class="pi pi-star"></i></span>
                        <span class="achievement-item achievement-item--violet"><i class="pi pi-send"></i></span>
                        <span class="achievement-item achievement-item--empty"><i class="pi pi-plus"></i></span>
                    </div>
                </div>

                <!-- Botones de acción contextuales -->
                <div class="profile-card-actions">
                    <button type="button" class="profile-action-btn profile-action-btn--primary"
                        (click)="toggleEditMode()">
                        <i class="pi pi-user-edit"></i>
                        <span>Editar Perfil</span>
                    </button>
                    <button type="button" class="profile-action-btn profile-action-btn--secondary"
                        routerLink="/teacher/change-password">
                        <i class="pi pi-lock"></i>
                        <span>Cambiar Contraseña</span>
                    </button>
                </div>
            </section>

            <aside class="profile-card-side">
                <div class="profile-indicators card">
                    <div class="profile-indicators__head">
                        <h3>Indicadores</h3>
                        <button type="button">Ver Historial</button>
                    </div>
                    <div class="indicator-row">
                        <div class="indicator-left">
                            <div class="indicator-icon indicator-icon--blue"><i class="pi pi-sparkles"></i></div>
                            <div>
                                <span>YACHAY</span>
                                <strong>{{ userIndicators?.yachay || 0 }}</strong>
                            </div>
                        </div>
                        <small class="indicator-up">+12% ↗</small>
                    </div>
                    <div class="indicator-row">
                        <div class="indicator-left">
                            <div class="indicator-icon indicator-icon--red"><i class="pi pi-heart-fill"></i></div>
                            <div>
                                <span>TUMIS</span>
                                <strong>{{ userIndicators?.tumis || 0 }}</strong>
                            </div>
                        </div>
                        <small class="indicator-up">+5% ↗</small>
                    </div>
                    <div class="indicator-row">
                        <div class="indicator-left">
                            <div class="indicator-icon indicator-icon--amber"><i class="pi pi-dollar"></i></div>
                            <div>
                                <span>MULLU</span>
                                <strong>{{ userIndicators?.mullu || 0 }}</strong>
                            </div>
                        </div>
                        <small class="indicator-muted">0% →</small>
                    </div>
                </div>

                <div class="profile-mission card">
                    <div class="profile-mission__head">
                        <h4>Misión: Perfil Completo</h4>
                        <span>{{ getProfileCompletion() }}%</span>
                    </div>
                    <p>Completa tu información para ganar 500 Mullu extra.</p>
                    <div class="mission-progress">
                        <span [style.width.%]="getProfileCompletion()"></span>
                    </div>
                    <div class="mission-footer">
                        <small>{{ 3 - (getProfileCompletion() >= 100 ? 3 : 2) }} pasos restantes</small>
                        <button type="button">Continuar Misión <i class="pi pi-arrow-right"></i></button>
                    </div>
                </div>
            </aside>

            <section class="profile-activity card">
                <div class="profile-activity__head">
                    <h3>Actividad Reciente</h3>
                    <button type="button">Ver Todo</button>
                </div>
                <div class="profile-activity__list">
                    <div class="activity-item" *ngFor="let activity of recentActivity">
                        <div class="activity-left">
                            <span class="activity-icon" [class.activity-icon--login]="activity.type === 'login'">
                                <i class="pi" [ngClass]="activity.icon"></i>
                            </span>
                            <div>
                                <strong>{{ activity.title }}</strong>
                                <p>{{ activity.time }}</p>
                            </div>
                        </div>
                        <small [class.activity-reward]="activity.reward">{{ activity.reward || '' }}</small>
                    </div>
                </div>
            </section>
        </div>
        }

        <!-- Modo edición -->
        @if (profileData && !loading && editMode) {
        <div class="profile-edit-wrapper">
            <form [formGroup]="profileForm" (ngSubmit)="saveProfile($event)">

                <!-- Header del editor -->
                <div class="profile-edit-header">
                    <div class="profile-edit-header__left">
                        <div class="profile-edit-icon">
                            <i class="pi pi-user-edit"></i>
                        </div>
                        <div>
                            <h2>Editar Perfil</h2>
                            <p>Actualiza tu información personal y avatar</p>
                        </div>
                    </div>
                </div>

                <!-- Cuerpo: dos columnas -->
                <div class="profile-edit-body">

                    <!-- Izquierda: Avatar -->
                    <aside class="profile-edit-avatar-panel">
                        <h4 class="profile-edit-section-title">
                            <i class="pi pi-image"></i> Elige tu avatar
                        </h4>
                        <div class="profile-edit-avatar-preview">
                            <img [src]="selectedAvatarPath || profileData.urlAvatar" alt="Avatar seleccionado">
                            <span class="profile-edit-avatar-badge"><i class="pi pi-check"></i></span>
                        </div>
                        <div class="profile-edit-avatar-grid">
                            @for (avatar of availableAvatars; track avatar) {
                            <button type="button" class="avatar-option" [class.selected]="selectedAvatarPath === avatar"
                                (click)="selectAvatar(avatar)">
                                <img [src]="avatar" alt="Avatar">
                            </button>
                            }
                        </div>
                        <small class="profile-edit-hint">
                            <i class="pi pi-info-circle"></i> Haz clic en un avatar para seleccionarlo
                        </small>
                    </aside>

                    <!-- Derecha: Campos -->
                    <div class="profile-edit-fields">
                        <h4 class="profile-edit-section-title">
                            <i class="pi pi-id-card"></i> Información Personal
                        </h4>

                        <div class="edit-fields-grid">

                            <!-- Nombre -->
                            <div class="edit-field">
                                <label for="ef-firstName" class="edit-label">
                                    <i class="pi pi-user"></i> Nombre
                                </label>
                                <input id="ef-firstName" type="text" pInputText formControlName="firstName"
                                    placeholder="Tu nombre" class="w-full">
                                <small class="edit-error"
                                    *ngIf="profileForm.get('firstName')?.invalid && profileForm.get('firstName')?.touched">
                                    <i class="pi pi-exclamation-circle"></i> Nombre es requerido
                                </small>
                            </div>

                            <!-- Apellido -->
                            <div class="edit-field">
                                <label for="ef-lastName" class="edit-label">
                                    <i class="pi pi-user"></i> Apellido
                                </label>
                                <input id="ef-lastName" type="text" pInputText formControlName="lastName"
                                    placeholder="Tu apellido" class="w-full">
                                <small class="edit-error"
                                    *ngIf="profileForm.get('lastName')?.invalid && profileForm.get('lastName')?.touched">
                                    <i class="pi pi-exclamation-circle"></i> Apellido es requerido
                                </small>
                            </div>

                            <!-- Cumpleaños -->
                            <div class="edit-field">
                                <label for="ef-birthday" class="edit-label">
                                    <i class="pi pi-calendar"></i> Fecha de Nacimiento
                                </label>
                                <input id="ef-birthday" type="text" pInputText formControlName="birthday"
                                    placeholder="DD/MM/YYYY" class="w-full">
                                <small class="edit-hint">Formato: DD/MM/YYYY</small>
                            </div>

                            <!-- WhatsApp -->
                            <div class="edit-field">
                                <label for="ef-whatsApp" class="edit-label">
                                    <i class="pi pi-whatsapp"></i> WhatsApp
                                </label>
                                <p-inputMask id="ef-whatsApp" mask="(999) 999-9999" formControlName="whatsApp"
                                    placeholder="(123) 456-7890" styleClass="w-full">
                                </p-inputMask>
                                <small class="edit-hint">Opcional — para contacto directo</small>
                            </div>

                            <!-- Género -->
                            <div class="edit-field">
                                <label for="ef-gender" class="edit-label">
                                    <i class="pi pi-heart"></i> Género
                                </label>
                                <p-select id="ef-gender" formControlName="gender" [options]="[
                        { label: 'Prefiero no indicar', value: '' },
                        { label: 'Masculino', value: 'masculino' },
                        { label: 'Femenino', value: 'femenino' }
                      ]" optionLabel="label" optionValue="value" placeholder="Selecciona" [showClear]="true"
                                    styleClass="w-full">
                                </p-select>
                                <small class="edit-hint">Opcional</small>
                            </div>

                            <!-- Institución -->
                            <div class="edit-field">
                                <label for="ef-institution" class="edit-label">
                                    <i class="pi pi-building"></i> Institución
                                </label>
                                <p-select id="ef-institution" formControlName="institutionId"
                                    [options]="institutionsOptions" optionLabel="name" optionValue="id"
                                    placeholder="Selecciona tu institución" [showClear]="true"
                                    [loading]="loadingInstitutions" styleClass="w-full">
                                </p-select>
                                <small class="edit-hint">Opcional</small>
                            </div>

                            <!-- Email (solo lectura) -->
                            <div class="edit-field edit-field--full">
                                <label class="edit-label edit-label--muted">
                                    <i class="pi pi-envelope"></i> Email
                                </label>
                                <div class="edit-readonly-field">
                                    <span>{{ profileData.email }}</span>
                                    <span class="edit-readonly-badge">
                                        <i class="pi pi-lock"></i> No editable
                                    </span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Footer: botones -->
                <div class="profile-edit-footer">
                    <button type="button" class="edit-btn edit-btn--cancel" (click)="cancelEdit()">
                        <i class="pi pi-times"></i> Cancelar
                    </button>
                    <button type="submit" class="edit-btn edit-btn--save"
                        [disabled]="profileForm.invalid || savingChanges">
                        <i class="pi" [ngClass]="savingChanges ? 'pi-spin pi-spinner' : 'pi-check'"></i>
                        {{ savingChanges ? 'Guardando...' : 'Guardar Cambios' }}
                    </button>
                </div>

            </form>
        </div>
        }

    </div>
</div>