<p-toast></p-toast>
<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

<!-- Spinner de carga inicial -->
<div *ngIf="loading()" class="flex justify-content-center align-items-center" style="height: 80vh;">
  <div class="spinner-container">
    <div class="spinner"></div>
  </div>
</div>

<!-- Fondo 3D con Three.js -->
<div class="fixed inset-0 z-0">
  <app-three-scene 
    #threeScene
    [width]="'100%'" 
    [height]="'100%'"
    [particleCount]="120"
    [particleColor]="particleColor">
  </app-three-scene>
</div>

<!-- Contenido principal - Dise帽o Duolingo -->
<div class="h-full inset-0 absolute bg-gradient-to-br from-blue-50/80 to-indigo-100/80 flex flex-col z-10">

  <!-- Barra de progreso superior -->
  <div class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
    <div class="max-w-4xl mx-auto">
      <!-- Contador de ejercicios (arriba, centrado) -->

      <div class="flex flex-col items-center justify-center mb-3">
        <span class="text-sm font-medium text-gray-600">
          Ejercicio {{ currentExerciseIndex() + 1 }} de {{ safeActivity.exercises.length }}
        </span>
      </div>

      <!-- Fila principal con bot贸n, barra de progreso y tumis -->
      <div class="flex items-center justify-between h-12">
        
        <!-- Bot贸n de retroceso -->
        <div class="flex items-center h-full">
          <p-button icon="pi pi-arrow-left"
                   styleClass="p-button-rounded p-button-text p-button-secondary h-10 w-10 flex items-center justify-center"
                   (click)="navigateBack()"
                   pTooltip="Volver atr谩s" 
                   tooltipPosition="bottom">
          </p-button>
        </div>

        <!-- Barra de progreso (ocupa el espacio disponible) -->
        <div class="flex-grow mx-4 h-full flex flex-col justify-center">
          <p-progressBar [value]="progress" [showValue]="false" styleClass="h-2 bg-gray-200"></p-progressBar>
        </div>

        <!-- Indicador de Tumis (vidas) -->
        <div class="flex items-center h-full">
          <div class="flex items-center gap-2 bg-gradient-to-r from-red-50 to-pink-50 px-4 py-2 rounded-full border border-red-200 shadow-sm h-10">
            <i class="pi pi-heart-fill text-red-500 text-xl"></i>
            <span class="text-red-700 font-semibold text-lg">{{ safeUserIndicators.tumis }}</span>
            <span class="text-red-600 text-sm font-medium">tumis</span>
          </div>
        </div>

      </div>

      <div class="flex flex-col items-center justify-center mb-3">
        <span class="text-xs text-gray-500">
          {{ progress.toFixed(0) }}% completado
        </span>
      </div>


    </div>
  </div>

  <!-- Contenido del ejercicio con scroll autom谩tico -->
  <div class="flex-1 px-6 py-1 overflow-y-auto">
    <div class="flex justify-center">
      <div class="w-[98%] sm:w-[90%] md:w-[80%] lg:w-[70%] max-w-none py-1">
      <div *ngIf="currentExercise" class="bg-white rounded-2xl shadow-xl">
        <div class="p-8">
        <div class="mb-6">
          <h2 class="text-2xl font-bold text-slate-800 mb-4">{{ currentExercise.statement }}</h2>
          
          <!-- Pista del ejercicio -->
          <div *ngIf="currentExercise.hind" class="bg-blue-50 p-4 rounded-lg mb-6 border-l-4 border-blue-500">
            <div class="flex items-start gap-3">
              <i class="pi pi-info-circle text-blue-500 text-xl mt-1"></i>
              <div>
                <h3 class="text-lg font-semibold text-blue-700 mb-1">Pista</h3>
                <p class="text-blue-800">{{ currentExercise.hind }}</p>
              </div>
            </div>
          </div>
          
          <!-- C贸digo del ejercicio (si existe) -->
          <div *ngIf="currentExercise.code" class="bg-slate-800 text-white p-4 rounded-lg mb-6 overflow-x-auto">
            <pre class="whitespace-pre-wrap"><code>{{ currentExercise.code }}</code></pre>
          </div>
        </div>
        
        <!-- Componente espec铆fico seg煤n el tipo de ejercicio -->
        <div [ngSwitch]="currentExercise.typeExercise" class="mb-6">
          <app-single-selection-exercise 
            *ngSwitchCase="'selection_single'"
            [options]="currentExercise.optionSelectOptions"
            [selectedOption]="answers()[currentExerciseIndex()] ? answers()[currentExerciseIndex()].answerSelect : undefined"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-single-selection-exercise>
          
          <app-multiple-selection-exercise 
            *ngSwitchCase="'selection_multiple'"
            [options]="currentExercise.optionSelectOptions"
            [selectedOptions]="answers()[currentExerciseIndex()] ? answers()[currentExerciseIndex()].answerSelects : []"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-multiple-selection-exercise>
          
          <app-order-fragment-code-exercise 
            *ngSwitchCase="'order_fragment_code'"
            [fragments]="currentExercise.optionOrderFragmentCode"
            [orderedFragments]="answers()[currentExerciseIndex()] ? answers()[currentExerciseIndex()].answerOrderFragmentCode : []"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-order-fragment-code-exercise>
          
          <app-order-line-code-exercise 
            *ngSwitchCase="'order_line_code'"
            [lines]="currentExercise.optionOrderLineCode"
            [orderedLines]="answers()[currentExerciseIndex()] ? answers()[currentExerciseIndex()].answerOrderLineCode : []"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-order-line-code-exercise>
          
          <app-write-code-exercise 
            *ngSwitchCase="'write_code'"
            [code]="answers()[currentExerciseIndex()] ? answers()[currentExerciseIndex()].answerWriteCode : ''"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-write-code-exercise>
          
          <app-find-error-code-exercise 
            *ngSwitchCase="'find_error_code'"
            [options]="currentExercise.optionFindErrorCode"
            [selectedError]="answers()[currentExerciseIndex()] ? answers()[currentExerciseIndex()].answerFindError : undefined"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-find-error-code-exercise>

          <app-vertical-ordering-exercise 
            *ngSwitchCase="'vertical_ordering'"
            [fragments]="currentExercise.optionsVerticalOrdering"
            [orderedFragments]="answers()[currentExerciseIndex()].answerVerticalOrdering || []"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-vertical-ordering-exercise>

          <app-horizontal-ordering-exercise 
            *ngSwitchCase="'horizontal_ordering'"
            [lines]="currentExercise.optionsHorizontalOrdering"
            [orderedLines]="answers()[currentExerciseIndex()].answerHorizontalOrdering || []"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-horizontal-ordering-exercise>

          <app-phishing-selection-multiple-exercise 
            *ngSwitchCase="'phishing_selection_multiple'"
            [options]="currentExercise.optionsPhishingSelection"
            [selectedOptions]="answers()[currentExerciseIndex()].answerPhishingSelection || []"
            [phishingContext]="currentExercise.phishingContext"
            [phishingImageUrl]="currentExercise.phishingImageUrl"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-phishing-selection-multiple-exercise>

          <app-match-pairs-exercise 
            *ngSwitchCase="'match_pairs'"
            [leftOptions]="currentExercise.optionsMatchPairsLeft"
            [rightOptions]="currentExercise.optionsMatchPairsRight"
            [matchedPairs]="answers()[currentExerciseIndex()].answerMatchPairs || []"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-match-pairs-exercise>
        </div>
        
        </div>
        
        <!-- Botones de acci贸n -->
        <div class="flex justify-center mt-8 mb-8">
          <!-- Bot贸n Verificar Respuesta (antes de verificar) -->
          <div *ngIf="!answerVerified()" class="flex gap-4 mb-8">
            <p-button
              label="Verificar Respuesta"
              icon="pi pi-check"
              styleClass="p-button-primary px-8 py-3 text-lg"
              (onClick)="verifyAnswer()"
              [loading]="submitting()"
              [disabled]="!hasAnswer()">
            </p-button>
          </div>

          <!-- Botones Siguiente/Anterior (despu茅s de verificar) -->
          <div *ngIf="answerVerified()" class="flex gap-4 mb-8">
            <p-button
              *ngIf="!isFirstExercise"
              label="Anterior"
              icon="pi pi-arrow-left"
              styleClass="p-button-secondary"
              (onClick)="previousExercise()">
            </p-button>

            <p-button
              [label]="isLastExercise ? 'Finalizar Actividad' : 'Siguiente'"
              [icon]="isLastExercise ? 'pi pi-check' : 'pi pi-arrow-right'"
              [styleClass]="isLastExercise ? 'p-button-success' : 'p-button-primary'"
              (onClick)="nextExercise()"
              [loading]="submitting()">
            </p-button>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Drawer de Feedback -->
<p-drawer
  [(visible)]="showFeedbackDrawer"
  [modal]="true"
  position="bottom"
  [style]="{'height': 'auto', 'border-radius': '16px 16px 0 0'}"
  [contentStyle]="{'padding': '0', 'border-radius': '16px 16px 0 0'}"
  [styleClass]="'feedback-drawer'"
  [showHeader]="false"
  [dismissible]="true"
  (onHide)="closeFeedbackDrawer()">

  <!-- Contenido del drawer de feedback -->
  <div class="feedback-drawer-content" *ngIf="showFeedback() && currentFeedback()">
    <!-- Handle para arrastrar -->
    <div class="flex justify-center py-3">
      <div class="w-12 h-1.5 bg-gradient-to-r from-transparent via-gray-400 to-transparent rounded-full"></div>
    </div>

    <!-- Contenedor principal con gradiente -->
    <div class="bg-gradient-to-br from-white to-gray-50">
      <div class="flex flex-col gap-6 px-6 py-8 max-w-6xl mx-auto">
      

        <!-- Contenido principal (Centro) -->
        <div class="w-full flex flex-col justify-center">
          <!-- Card de feedback -->
          <div [ngClass]="{
            'bg-gradient-to-br from-green-50 to-emerald-50 border-green-200 shadow-lg shadow-green-200/30': safeFeedback.qualification >= 7, 
            'bg-gradient-to-br from-amber-50 to-yellow-50 border-amber-200 shadow-lg shadow-amber-200/30': safeFeedback.qualification >= 5 && safeFeedback.qualification < 7, 
            'bg-gradient-to-br from-red-50 to-rose-50 border-red-200 shadow-lg shadow-red-200/30': safeFeedback.qualification < 5
          }" class="rounded-2xl border-2 p-6 backdrop-blur-sm flex flex-auto flex-col">
            
            <!-- Header con 铆cono -->
            <div class="flex items-start gap-4 mb-4">
              <div [ngClass]="{
                'bg-gradient-to-br from-green-400 to-emerald-500 text-white': safeFeedback.qualification >= 7, 
                'bg-gradient-to-br from-amber-400 to-yellow-500 text-white': safeFeedback.qualification >= 5 && safeFeedback.qualification < 7, 
                'bg-gradient-to-br from-red-400 to-rose-500 text-white': safeFeedback.qualification < 5
              }" class="p-3 rounded-xl shadow-lg">
                <i [ngClass]="{
                  'pi-check-circle': safeFeedback.qualification >= 7, 
                  'pi-exclamation-circle': safeFeedback.qualification >= 5 && safeFeedback.qualification < 7, 
                  'pi-times-circle': safeFeedback.qualification < 5
                }" class="pi text-2xl"></i>
              </div>
              
              <div class="flex-1">
                <h3 [ngClass]="{
                  'text-green-800': safeFeedback.qualification >= 7, 
                  'text-amber-800': safeFeedback.qualification >= 5 && safeFeedback.qualification < 7, 
                  'text-red-800': safeFeedback.qualification < 5
                }" class="text-3xl font-bold mb-1">
                  {{ safeFeedback.qualification >= 7 ? '隆Excelente!' : safeFeedback.qualification >= 5 ? '隆Buen intento!' : '隆Sigue practicando!' }}
                </h3>
                <p class="text-gray-600 text-sm font-medium">
                  {{ safeFeedback.qualification >= 7 ? '隆Dominas este concepto!' : safeFeedback.qualification >= 5 ? 'Est谩s muy cerca' : 'Necesitas m谩s pr谩ctica' }}
                </p>
              </div>
            </div>

            <!-- Puntuaci贸n destacada -->
            <div class="flex items-center gap-3 mb-4 p-4 rounded-xl" [ngClass]="{
              'bg-green-100/50': safeFeedback.qualification >= 7, 
              'bg-amber-100/50': safeFeedback.qualification >= 5 && safeFeedback.qualification < 7, 
              'bg-red-100/50': safeFeedback.qualification < 5
            }">
              <span class="text-sm font-semibold text-gray-700">Puntuaci贸n:</span>
              <span [ngClass]="{
                'text-green-600': safeFeedback.qualification >= 7, 
                'text-amber-600': safeFeedback.qualification >= 5 && safeFeedback.qualification < 7, 
                'text-red-600': safeFeedback.qualification < 5
              }" class="text-3xl font-bold">
                {{ safeFeedback.qualification }}<span class="text-lg">/10</span>
              </span>
            </div>

            <!-- Bot贸n de retroalimentaci贸n detallada -->
            <button 
              (click)="showAIFeedbackModal.set(true)" 
              class="w-full p-3 text-sm font-semibold rounded-lg flex items-center justify-center gap-2 cursor-pointer"
              [ngClass]="{
                'bg-green-100 text-green-700 hover:bg-green-200': safeFeedback.qualification >= 7, 
                'bg-amber-100 text-amber-700 hover:bg-amber-200': safeFeedback.qualification >= 5 && safeFeedback.qualification < 7, 
                'bg-red-100 text-red-700 hover:bg-red-200': safeFeedback.qualification < 5
              }">
              <i class="pi pi-lightbulb"></i>
              <span>Ver retroalimentaci贸n detallada</span>
              <i class="pi pi-chevron-right"></i>
            </button>
          </div>
        </div>

        <!-- Botones de acci贸n (Derecha) -->
        <div class="w-full flex flex-col gap-3 justify-center">
          <button
            pButton
            label="Revisar"
            icon="pi pi-eye"
            class="p-button-outlined p-button-secondary w-full font-semibold"
            (click)="closeFeedbackDrawer()">
          </button>
          
          <button
            pButton
            [label]="isLastExercise ? 'Finalizar' : 'Siguiente'"
            [icon]="isLastExercise ? 'pi pi-check' : 'pi pi-arrow-right'"
            [iconPos]="'right'"
            [class]="isLastExercise ? 'p-button-success w-full font-semibold' : 'p-button-primary w-full font-semibold'"
            (click)="isLastExercise ? finishActivity() : continueFromFeedback()">
          </button>

          <!-- Indicador de progreso -->
          <div class="text-center mt-2">
            <span class="text-xs font-semibold text-gray-500">
              Ejercicio {{ currentExerciseIndex() + 1 }} de {{ safeActivity.exercises.length }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</p-drawer>

<!-- Modal de Feedback de IA -->
<p-dialog
  [(visible)]="showAIFeedbackModal"
  [modal]="true"
  header="Retroalimentaci贸n de Amauta"
  [style]="{ width: '100rem' }"
  [closeOnEscape]="true"
  [dismissableMask]="true"
  [closable]="false">

  
  <!-- Contenido del modal -->
  <div class="bg-gradient-to-b ">
    <!-- Layout responsivo: columnas en desktop, filas en m贸vil -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-0 min-h-[500px]">
      
      <!-- Lado izquierdo - Imagen y contexto (2 columnas en desktop) -->
      <div class="lg:col-span-2 bg-gradient-to-br from-[#12BA82]/5 via-[#12BA82]/3 to-transparent p-8 lg:p-10 flex flex-col items-center justify-center border-b lg:border-b-0 lg:border-r border-slate-200">
        <div class="relative w-full max-w-sm">
          <!-- Elementos decorativos de fondo -->
          <div class="absolute -top-8 -left-8 w-40 h-40 bg-[#12BA82]/10 rounded-full blur-3xl opacity-60"></div>
          <div class="absolute -bottom-8 -right-8 w-40 h-40 bg-[#0FA573]/10 rounded-full blur-3xl opacity-60"></div>
          
          <!-- Imagen -->
          <div class="relative z-10">
            <img 
              src="https://i.ibb.co/Zz3XV6xj/amauta.png" 
              alt="Amauta - Retroalimentaci贸n de IA" 
              class="w-full h-auto max-h-72 object-contain drop-shadow-lg hover:drop-shadow-xl transition-shadow duration-300"
              onerror="this.src='assets/images/placeholder-feedback.svg'"
            >
          </div>
        </div>
        
        <!-- Informaci贸n contextual -->
        <div class="mt-10 text-center space-y-3">
          <div class="inline-flex items-center gap-2 bg-[#12BA82]/10 px-4 py-2 rounded-full border border-[#12BA82]/20 hover:border-[#12BA82]/40 transition-colors duration-200">
            <i class="pi pi-check-circle text-[#12BA82] text-sm"></i>
            <span class="text-sm font-medium text-[#0D9B6A]">An谩lisis completado</span>
          </div>
          <h3 class="text-lg font-bold text-gray-800">Retroalimentaci贸n Personalizada</h3>
          <p class="text-sm text-gray-600 leading-relaxed">Amauta ha analizado tu desempe帽o y preparado recomendaciones espec铆ficas para tu mejora continua.</p>
        </div>
      </div>
      
      <!-- Lado derecho - Feedback de IA (3 columnas en desktop) -->
      <div class="lg:col-span-3 p-8 lg:p-10 flex flex-col">
        <!-- Contenedor scrolleable -->
        <div class="flex-1 overflow-y-auto pr-4 space-y-6 scrollbar-thin scrollbar-thumb-[#12BA82] scrollbar-track-slate-100 hover:scrollbar-thumb-[#0FA573]">
          
          <!-- Tarjeta de consejo del sistema -->
          <div class="bg-gradient-to-r from-[#12BA82]/10 to-[#0FA573]/10 border border-[#12BA82]/30 rounded-xl p-5 backdrop-blur-sm hover:border-[#12BA82]/50 hover:shadow-md transition-all duration-300">
            <div class="flex items-start gap-4">
              <div class="flex-shrink-0">
                <div class="flex items-center justify-center h-10 w-10 rounded-lg bg-[#12BA82]/20 group-hover:bg-[#12BA82]/30 transition-colors duration-200">
                  <i class="pi pi-lightbulb text-[#12BA82] text-lg"></i>
                </div>
              </div>
              <div class="flex-1">
                <h4 class="text-sm font-bold text-[#0D9B6A] mb-1">Consejo de Amauta</h4>
                <p class="text-sm text-gray-700 leading-relaxed">Revisa cuidadosamente esta retroalimentaci贸n. Cada recomendaci贸n est谩 dise帽ada para ayudarte a mejorar tu comprensi贸n sobre ciberseguridad.</p>
              </div>
            </div>
          </div>
          
          <!-- Contenido del feedback con estilos mejorados -->
          <div class="space-y-4">
            <div class="text-gray-700 text-sm leading-relaxed">
              <!-- Estilos din谩micos para el contenido HTML -->
              <div 
                [innerHTML]="safeFeedback.feedback"
                class="prose prose-sm max-w-none
                  prose-headings:text-[#0D9B6A] prose-headings:font-bold prose-headings:mt-4 prose-headings:mb-2
                  prose-p:text-gray-700 prose-p:mb-3 prose-p:leading-relaxed
                  prose-li:text-gray-700 prose-li:mb-2
                  prose-code:bg-slate-100 prose-code:text-[#0D9B6A] prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-xs
                  prose-blockquote:border-l-4 prose-blockquote:border-[#12BA82] prose-blockquote:pl-4 prose-blockquote:text-gray-600 prose-blockquote:italic
                  prose-strong:text-[#0D9B6A] prose-strong:font-bold
                  prose-ul:list-disc prose-ul:pl-5 prose-ul:mb-4
                  prose-ol:list-decimal prose-ol:pl-5 prose-ol:mb-4">
              </div>
            </div>
          </div>
          
          <!-- Separador visual -->
          <div class="flex items-center gap-3 py-4">
            <div class="flex-1 h-px bg-gradient-to-r from-slate-200 to-transparent"></div>
            <span class="text-xs text-gray-500 font-medium whitespace-nowrap">Fin de la retroalimentaci贸n</span>
            <div class="flex-1 h-px bg-gradient-to-l from-slate-200 to-transparent"></div>
          </div>
          
          <!-- Secci贸n de calificaci贸n con estrellas -->
          <div class="bg-gradient-to-br from-yellow-50 to-amber-50 border border-yellow-200 rounded-xl p-6 hover:border-yellow-300 transition-all duration-300">
            <div class="space-y-4">
              <div class="flex items-start gap-3">
                <div class="flex-shrink-0">
                  <div class="flex items-center justify-center h-10 w-10 rounded-full bg-yellow-100">
                    <i class="pi pi-star-fill text-yellow-500 text-lg"></i>
                  </div>
                </div>
                <div class="flex-1">
                  <h4 class="text-sm font-bold text-gray-800 mb-1">Califica esta retroalimentaci贸n</h4>
                  <p class="text-xs text-gray-600">Tu opini贸n nos ayuda a mejorar la calidad de las respuestas de Amauta</p>
                </div>
              </div>
              
              <!-- Componente de estrellas -->
              <div class="flex justify-center py-3">
                <app-star-rating 
                  [(rating)]="feedbackRating"
                  (ratingChange)="onFeedbackRatingChange($event)"
                  [disabled]="submittingRating">
                </app-star-rating>
              </div>
              
              <!-- Campo de comentario opcional -->
              <div *ngIf="feedbackRating > 0" class="space-y-2" style="animation: fadeIn 0.3s ease-out;">
                <label class="text-xs font-medium text-gray-700">Comentario (opcional)</label>
                <textarea
                  [(ngModel)]="feedbackComment"
                  placeholder="Cu茅ntanos qu茅 te pareci贸 esta retroalimentaci贸n..."
                  class="w-full px-3 py-2 text-xs border border-yellow-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent resize-none"
                  rows="2"
                  [disabled]="submittingRating">
                </textarea>
              </div>
              
              <!-- Bot贸n de env铆o -->
              <div *ngIf="feedbackRating > 0" class="flex gap-2 pt-2">
                <button
                  (click)="submitFeedbackRating()"
                  [disabled]="submittingRating"
                  class="flex-1 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 disabled:bg-gray-300 text-white text-xs font-medium rounded-lg transition-colors duration-200 active:scale-95">
                  <i class="pi pi-check mr-1" *ngIf="!submittingRating"></i>
                  <i class="pi pi-spin pi-spinner mr-1" *ngIf="submittingRating"></i>
                  {{ submittingRating ? 'Enviando...' : 'Enviar calificaci贸n' }}
                </button>
                <button
                  (click)="clearFeedbackRating()"
                  [disabled]="submittingRating"
                  class="px-4 py-2 bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 text-gray-700 text-xs font-medium rounded-lg transition-colors duration-200 active:scale-95">
                  <i class="pi pi-times"></i>
                </button>
              </div>
              
              <!-- Mensaje de 茅xito -->
              <div *ngIf="feedbackSubmitted" class="flex items-center gap-2 px-3 py-2 bg-green-50 border border-green-200 rounded-lg" style="animation: fadeIn 0.3s ease-out;">
                <i class="pi pi-check-circle text-green-600"></i>
                <span class="text-xs text-green-700 font-medium">隆Gracias por tu calificaci贸n!</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Footer del modal -->
  <ng-template pTemplate="footer">
      <p-button 
        type="button" 
        label="Cerrar" 
        icon="pi pi-check"
        class="p-button-rounded p-button-text text-gray-700 hover:bg-slate-100 hover:text-gray-900 transition-all duration-200 active:scale-95" 
        (click)="showAIFeedbackModal.set(false)">
      </p-button>
  </ng-template>
</p-dialog>

<!-- Modal de resultados de actividad completada -->
<p-dialog
  [(visible)]="showResultsModal"
  [modal]="true"
  [closeOnEscape]="false"
  [closable]="false"
  [draggable]="false"
  [resizable]="false"
  [style]="{width: '100vw', height: '100vh', 'max-width': '100vw', 'max-height': '100vh'}"
  [contentStyle]="{'height': '100%', 'padding': '0'}"
  [maskStyle]="{'background-color': 'rgba(0, 0, 0, 0.8)'}"
  styleClass="fullscreen-results-modal">

  <!-- Contenido del modal -->
  <div class="results-modal-content">
    <div class="text-center py-12 px-6">
      <div class="mb-12">
        <div class="flex justify-center mb-6">
          <div class="w-32 h-32 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center shadow-2xl">
            <i class="pi pi-check-circle text-white text-6xl"></i>
          </div>
        </div>

        <h1 class="text-5xl font-bold text-slate-900 mb-4">隆Actividad completada!</h1>
        <p class="text-2xl text-slate-600">Has completado la actividad "{{ safeActivityResult.activity }}"</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12 max-w-6xl mx-auto">
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-8 rounded-2xl shadow-xl border border-blue-200">
          <div class="text-blue-600 text-5xl font-bold mb-3">{{ safeActivityResult.score }}</div>
          <div class="text-blue-700 font-semibold text-lg">Puntuaci贸n total</div>
        </div>

        <div class="bg-gradient-to-br from-green-50 to-green-100 p-8 rounded-2xl shadow-xl border border-green-200">
          <div class="text-green-600 text-5xl font-bold mb-3">{{ safeActivityResult.accuracy }}%</div>
          <div class="text-green-700 font-semibold text-lg">Precisi贸n</div>
        </div>

        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-8 rounded-2xl shadow-xl border border-amber-200">
          <div class="text-amber-600 text-5xl font-bold mb-3">+{{ safeActivityResult.gems }}</div>
          <div class="text-amber-700 font-semibold text-lg">Yachay ganados</div>
        </div>

        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-8 rounded-2xl shadow-xl border border-purple-200">
          <div class="flex items-center justify-center gap-2 mb-3">
            <span class="text-5xl"></span>
            <div class="text-purple-600 text-5xl font-bold">+{{ safeActivityResult.mulluEarned || 0 }}</div>
          </div>
          <div class="text-purple-700 font-semibold text-lg">Mullu ganados</div>
        </div>
      </div>

      <div class="flex flex-col md:flex-row justify-center gap-6">
        <p-button
          label="Volver a los temas"
          icon="pi pi-arrow-left"
          styleClass="p-button-secondary p-button-lg px-8 py-4 text-lg"
          (onClick)="navigateBack()">
        </p-button>

        <p-button
          label="Reintentar actividad"
          icon="pi pi-refresh"
          styleClass="p-button-primary p-button-lg px-8 py-4 text-lg"
          (onClick)="restartActivity()">
        </p-button>
      </div>
    </div>
  </div>
</p-dialog>
