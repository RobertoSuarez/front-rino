<p-toast></p-toast>
<div class="grid grid-cols-12 gap-4 md:gap-8">
    <div class="col-span-12">
        <!-- Header con gradiente -->
        <div class="card mb-0 overflow-hidden">
            <div class="flex flex-col md:flex-row md:align-items-center md:justify-between p-3 md:p-4">
                <div class="flex align-items-center gap-3 md:gap-4 mb-3 md:mb-0">
                    <i class="pi pi-user text-900 !text-2xl md:!text-3xl mr-2 md:mr-3"></i>
                    <div>
                        <div class="text-900 m-0 font-bold text-lg md:text-xl">Mi Perfil</div>
                        <div class="text-600 m-0 text-sm md:text-base">Gestiona tu información personal</div  >
                    </div>
                </div>
                @if (!editMode && profileData) {
                <div class="flex flex-col sm:flex-row gap-2">
                    <button pButton label="Editar Perfil" icon="pi pi-user-edit"
                        class="p-button-outlined p-button-rounded w-full sm:w-auto" (click)="toggleEditMode()"></button>
                    <button pButton label="Cambiar Contraseña" icon="pi pi-lock"
                        class="p-button-outlined p-button-rounded p-button-secondary w-full sm:w-auto" routerLink="/teacher/change-password"></button>
                </div>
                }
            </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="loading" class="card">
            <div class="flex justify-content-center align-items-center min-h-[300px] md:min-h-[400px]">
                <div class="text-center">
                    <p-progressSpinner strokeWidth="3" animationDuration="1s"></p-progressSpinner>
                    <p class="text-600 mt-3 text-sm md:text-base">Cargando información del perfil...</p>
                </div>
            </div>
        </div>

        <!-- Error State -->
        @if(error && !loading) {
        <div class="card">
            <div class="flex align-items-center justify-content-center p-4 md:p-6 border-round-lg"
                style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 1px solid #f87171;">
                <div class="text-center">
                    <i class="pi pi-exclamation-triangle text-red-500 text-3xl md:text-4xl mb-3"></i>
                    <h4 class="text-red-800 m-0 mb-2 text-lg md:text-xl">Error al cargar el perfil</h4>
                    <p class="text-red-600 m-0 text-sm md:text-base">{{ error }}</p>
                </div>
            </div>
        </div>
        }

        <!-- Modo visualización -->
        @if (profileData && !loading && !editMode) {
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-6">
            <!-- Tarjeta de perfil principal -->
            <div class="col-span-1 md:col-span-6">
                <div class="card text-center h-full">
                    <div class="relative inline-block mb-4">
                        <img [src]="profileData.urlAvatar" class="rounded-3xl shadow-4 w-[150px] h-[150px] md:w-[180px] md:h-[180px]"
                            style="object-fit: cover; border: 4px solid var(--surface-border);"
                            alt="Avatar de usuario">
                        <div class="absolute bg-green-500 border-circle shadow-2 w-5 h-5 md:w-6 md:h-6"
                            style="bottom: 8px; right: 8px; border: 3px solid white;">
                        </div>
                    </div>

                    <h2 class="text-900 font-bold text-xl md:text-2xl m-0 mb-2">{{ profileData.firstName }} {{ profileData.lastName
                        }}</h2>
                    <p class="text-600 text-base md:text-lg mb-4">{{ profileData.email }}</p>

                    <!-- Tipo de Usuario -->
                    <div class="mb-4">
                        <p-tag 
                            [value]="getUserTypeLabel(profileData.typeUser)" 
                            [severity]="getUserTypeColor(profileData.typeUser)"
                            icon="pi pi-user">
                        </p-tag>
                    </div>

                    <div class="surface-100 border-round-lg p-3 mb-3 flex align-items-center justify-content-between">
                        <div class="flex align-items-center">
                            <i class="pi pi-calendar text-primary mr-2"></i>
                            <span class="text-700 font-medium text-sm md:text-base">Miembro desde:</span>
                        </div>
                        <span class="text-900 font-bold text-sm md:text-base ml-2">{{ formatDate(profileData.createdAt) }}</span>
                    </div>

                    <div *ngIf="profileData.birthday" class="surface-100 border-round-lg p-3 mb-3 flex align-items-center justify-content-between">
                        <div class="flex align-items-center">
                            <i class="pi pi-gift text-pink-500 mr-2"></i>
                            <span class="text-700 font-medium text-sm md:text-base">Cumpleaños:</span>
                        </div>
                        <span class="text-900 font-bold text-sm md:text-base ml-2">{{ formatDate(profileData.birthday) }}</span>
                    </div>

                    <div *ngIf="profileData.whatsApp" class="surface-100 border-round-lg p-3 mb-3 flex align-items-center justify-content-between">
                        <div class="flex align-items-center">
                            <i class="pi pi-whatsapp text-green-500 mr-2"></i>
                            <span class="text-700 font-medium text-sm md:text-base">WhatsApp:</span>
                        </div>
                        <span class="text-900 font-bold text-sm md:text-base ml-2">{{ profileData.whatsApp }}</span>
                    </div>

                    <div *ngIf="profileData.gender" class="surface-100 border-round-lg p-3 flex align-items-center justify-content-between">
                        <div class="flex align-items-center">
                            <i class="pi pi-heart text-rose-500 mr-2"></i>
                            <span class="text-700 font-medium text-sm md:text-base">Género:</span>
                        </div>
                        <span class="text-900 font-bold text-sm md:text-base ml-2">
                            {{ profileData.gender === 'masculino' ? 'Masculino' : profileData.gender === 'femenino' ? 'Femenino' : profileData.gender }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Estadísticas del Usuario -->
            <div class="col-span-1 md:col-span-6">
                <div class="card h-full">
                    <div class="flex mb-4 gap-4 items-center w-full">
                        <i class="pi pi-chart-bar text-primary text-xl md:text-2xl"></i>
                        <h3 class="text-900 font-bold text-lg md:text-xl m-0">Indicadores del Usuario</h3>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6 xl:gap-8" *ngIf="userIndicators">
                        <!-- Yachay Card -->
                        <div class="col-span-1">
                            <div
                                class="surface-card min-h-[180px] md:min-h-[220px] p-3 md:p-5 text-center shadow-2 hover:shadow-4 transition-all transition-duration-300 cursor-pointer transform hover:scale-102 border-1 border-blue-200"
                                style="border-radius: 25px;"
                                pTooltip="Puntos de experiencia acumulados" tooltipPosition="bottom">
                                <div class="inline-flex items-center justify-center mb-4"
                                    style="width: 80px; height: 80px;">
                                    <img src="assets/elementos/yachay.png" alt="Yachay" class="w-full h-full object-contain rounded-xl">
                                </div>
                                <div class="text-900 font-bold text-3xl md:text-4xl mb-2">{{ userIndicators.yachay }}</div>
                                <div class="text-600 font-semibold text-lg md:text-xl mb-3">Yachay</div>
                            </div>
                        </div>

                        <!-- Tumis Card -->
                        <div class="col-span-1">
                            <div
                                class="surface-card min-h-[180px] md:min-h-[220px] p-3 md:p-5 text-center shadow-2 hover:shadow-4 transition-all transition-duration-300 cursor-pointer transform hover:scale-102 border-1 border-red-200"
                                style="border-radius: 25px;"
                                pTooltip="Vidas disponibles" tooltipPosition="bottom">
                                <div class="inline-flex items-center justify-center mb-4"
                                    style="width: 80px; height: 80px;">
                                    <img src="assets/elementos/corazon_de_tumi.png" alt="Tumis" class="w-full h-full object-contain rounded-xl">
                                </div>
                                <div class="text-900 font-bold text-3xl md:text-4xl mb-2">{{ userIndicators.tumis }}</div>
                                <div class="text-600 font-semibold text-lg md:text-xl mb-3">Tumis</div>
                            </div>
                        </div>

                        <!-- Mullu Card -->
                        <div class="col-span-1">
                            <div
                                class="surface-card min-h-[180px] md:min-h-[220px] p-3 md:p-5 text-center shadow-2 hover:shadow-4 transition-all transition-duration-300 cursor-pointer transform hover:scale-102 border-1 border-yellow-200"
                                style="border-radius: 25px;"
                                pTooltip="Moneda virtual disponible" tooltipPosition="bottom">
                                <div class="inline-flex items-center justify-center mb-4"
                                    style="width: 80px; height: 80px;">
                                    <img src="assets/elementos/mullu.png" alt="Mullu" class="w-full h-full object-contain rounded-xl">
                                </div>
                                <div class="text-900 font-bold text-3xl md:text-4xl mb-2">{{ userIndicators.mullu }}</div>
                                <div class="text-600 font-semibold text-lg md:text-xl mb-3">Mullu</div>
                            </div>
                        </div>
                    </div>

                    <!-- Progreso del perfil integrado -->
                    <div class="mt-4 pt-4 border-top-1 surface-border">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-900 font-bold m-0">Progreso del Perfil</h4>
                            <span class="text-900 font-bold">85%</span>
                        </div>
                        <div class="bg-gray-200 border-round-lg overflow-hidden mb-3" style="height: 8px;">
                            <div class="bg-primary border-round-lg h-full transition-all transition-duration-1000"
                                style="width: 85%;"></div>
                        </div>
                        <p class="text-600 text-sm m-0">¡Completa tu información para desbloquear más funciones!</p>
                    </div>
                </div>
            </div>
        </div>

        }

        <!-- Modo edición mejorado -->
        @if (profileData && !loading && editMode) {
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-6">
            <div class="col-span-1 md:col-span-12">
                <div class="w-full p-4 md:p-8 rounded-lg bg-white">
                    <div class="flex flex-col md:flex-row w-full md:justify-between mb-4 md:mb-0">
                        <div class="flex items-center gap-2 mb-3 md:mb-0">
                            <i class="pi pi-user-edit text-primary !text-xl md:!text-2xl mr-2 md:mr-3"></i>
                            <div class="flex flex-col">
                                <div class="text-900 font-bold text-lg md:text-xl m-0">Editar Perfil</div>
                                <p class="text-600 m-0 text-sm md:text-base">Actualiza tu información personal</p>
                            </div>
                        </div>
                        <button pButton type="button" icon="pi pi-times !text-xl md:!text-2xl"
                            class="p-button-rounded p-button-text p-button-plain self-end md:self-auto" (click)="cancelEdit()"></button>
                    </div>

                    <form [formGroup]="profileForm" (ngSubmit)="saveProfile($event)" class="p-fluid">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-6">
                            <!-- Sección de Avatar -->
                            <div class="col-span-1 md:col-span-6">
                                <div class="surface-50 border-round-lg p-3 md:p-4 text-center h-full">
                                    <h4 class="text-900 font-bold mb-4 text-lg md:text-xl">Foto de Perfil</h4>

                                    <!-- Preview del Avatar Seleccionado -->
                                    <div class="relative inline-block mb-6">
                                        <img [src]="selectedAvatarPath || 'https://via.placeholder.com/180x180/e2e8f0/64748b?text=Avatar'"
                                            class="rounded-3xl shadow-3 w-[150px] h-[150px] md:w-[180px] md:h-[180px]"
                                            style="object-fit: cover; border: 4px solid var(--primary-color);"
                                            alt="Avatar de usuario">
                                    </div>

                                    <!-- Grid de Avatares Disponibles -->
                                    <div class="mb-4">
                                        <label class="font-medium text-900 text-sm md:text-base block mb-3">Selecciona tu Avatar</label>
                                        <div class="grid grid-cols-3 md:grid-cols-3 gap-2 md:gap-3">
                                            @for (avatar of availableAvatars; track avatar) {
                                            <div class="cursor-pointer transition-all transition-duration-200 hover:scale-110"
                                                (click)="selectAvatar(avatar)"
                                                [ngClass]="{'ring-2 ring-primary rounded-2xl': selectedAvatarPath === avatar}">
                                                <img [src]="avatar"
                                                    class="w-full h-auto rounded-2xl shadow-1 hover:shadow-3 transition-all transition-duration-200"
                                                    style="aspect-ratio: 1; object-fit: cover;"
                                                    alt="Avatar option"
                                                    [ngClass]="{'ring-2 ring-primary': selectedAvatarPath === avatar}">
                                            </div>
                                            }
                                        </div>
                                        <small
                                            *ngIf="profileForm.get('urlAvatar')?.invalid && profileForm.get('urlAvatar')?.touched"
                                            class="p-error block mt-2">
                                            <i class="pi pi-exclamation-circle mr-1"></i>Debes seleccionar un avatar
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Formulario de datos personales -->
                            <div class="col-span-1 md:col-span-6">
                                <div class="surface-50 border-round-lg p-3 md:p-4 h-full">
                                    <h4 class="text-900 font-bold mb-4 text-lg md:text-xl">Información Personal</h4>

                                    <div class="flex flex-col w-full gap-3 md:gap-4">
                                        
                                        <div class="w-full flex flex-col md:flex-row gap-2 md:gap-4 md:items-center p-2">
                                            <label for="firstName" class="font-medium text-900 text-sm md:text-base md:min-w-[100px]">
                                                <i class="pi pi-user mr-2 text-primary"></i>Nombre
                                            </label>
                                            <div class="flex-1">
                                                <input id="firstName" type="text" pInputText formControlName="firstName"
                                                    class="w-full" placeholder="Ingresa tu nombre">
                                                <small
                                                    *ngIf="profileForm.get('firstName')?.invalid && profileForm.get('firstName')?.touched"
                                                    class="p-error block mt-1">
                                                    <i class="pi pi-exclamation-circle mr-1"></i>Nombre es requerido
                                                </small>
                                            </div>
                                        </div>

                                        <div class="w-full flex flex-col md:flex-row gap-2 md:gap-4 md:items-center p-2">
                                            <label for="lastName" class="font-medium text-900 text-sm md:text-base md:min-w-[100px]">
                                                <i class="pi pi-user mr-2 text-primary"></i>Apellido
                                            </label>
                                            <div class="flex-1">
                                                <input id="lastName" type="text" pInputText formControlName="lastName"
                                                    class="w-full" placeholder="Ingresa tu apellido">
                                                <small
                                                    *ngIf="profileForm.get('lastName')?.invalid && profileForm.get('lastName')?.touched"
                                                    class="p-error block mt-1">
                                                    <i class="pi pi-exclamation-circle mr-1"></i>Apellido es requerido
                                                </small>
                                            </div>
                                        </div>

                                        <div class="w-full flex flex-col md:flex-row gap-2 md:gap-4 md:items-center p-2">
                                            <label for="birthday" class="font-medium text-900 text-sm md:text-base md:min-w-[100px]">
                                                <i class="pi pi-calendar mr-2 text-pink-500"></i>Fecha de Nacimiento
                                            </label>
                                            <div class="flex-1">
                                                <input id="birthday" type="text" pInputText formControlName="birthday"
                                                    class="w-full" placeholder="DD/MM/YYYY">
                                                <small class="text-600 block mt-1 text-xs md:text-sm">Formato: DD/MM/YYYY</small>
                                            </div>
                                        </div>

                                        <div class="w-full flex flex-col md:flex-row gap-2 md:gap-4 md:items-center p-2">
                                            <label for="whatsApp" class="font-medium text-900 text-sm md:text-base md:min-w-[100px]">
                                                <i class="pi pi-whatsapp mr-2 text-green-500"></i>WhatsApp
                                            </label>
                                            <div class="flex-1">
                                                <p-inputMask id="whatsApp" mask="(999) 999-9999"
                                                    formControlName="whatsApp"
                                                    placeholder="(123) 456-7890">
                                                </p-inputMask>
                                                <small class="text-600 block mt-1 text-xs md:text-sm">Opcional - Para contacto directo</small>
                                                <small
                                                    *ngIf="profileForm.get('whatsApp')?.invalid && profileForm.get('whatsApp')?.touched"
                                                    class="p-error block mt-1">
                                                    <i class="pi pi-exclamation-circle mr-1"></i>WhatsApp es requerido
                                                </small>
                                            </div>
                                        </div>

                                        <div class="w-full flex flex-col md:flex-row gap-2 md:gap-4 md:items-center p-2">
                                            <label for="gender" class="font-medium text-900 text-sm md:text-base md:min-w-[100px]">
                                                <i class="pi pi-heart mr-2 text-rose-500"></i>Género
                                            </label>
                                            <div class="flex-1">
                                                <p-select 
                                                    id="gender"
                                                    formControlName="gender"
                                                    [options]="[
                                                        { label: 'Selecciona tu género', value: '' },
                                                        { label: 'Masculino', value: 'masculino' },
                                                        { label: 'Femenino', value: 'femenino' }
                                                    ]"
                                                    optionLabel="label"
                                                    optionValue="value"
                                                    placeholder="Selecciona tu género"
                                                    [showClear]="true"
                                                    class="w-full">
                                                </p-select>
                                                <small class="text-600 block mt-1 text-xs md:text-sm">Opcional - Selecciona tu género</small>
                                            </div>
                                        </div>

                                        <div class="w-full flex flex-col md:flex-row gap-2 md:gap-4 md:items-center p-2">
                                            <label for="institutionId" class="font-medium text-900 text-sm md:text-base md:min-w-[100px]">
                                                <i class="pi pi-building mr-2 text-purple-500"></i>Institución
                                            </label>
                                            <div class="flex-1">
                                                <p-select 
                                                    id="institutionId"
                                                    formControlName="institutionId"
                                                    [options]="institutionsOptions"
                                                    optionLabel="name"
                                                    optionValue="id"
                                                    placeholder="Selecciona tu institución"
                                                    [showClear]="true"
                                                    [loading]="loadingInstitutions"
                                                    class="w-full">
                                                </p-select>
                                                <small class="text-600 block mt-1 text-xs md:text-sm">Opcional - Selecciona tu institución educativa</small>
                                            </div>
                                        </div>

                                        <div class="w-full flex flex-col md:flex-row gap-2 md:gap-4 md:items-center p-2">
                                            <label class="font-medium text-900 text-sm md:text-base md:min-w-[100px]">
                                                <i class="pi pi-envelope mr-2 text-blue-500"></i>Email
                                            </label>
                                            <div class="flex-1">
                                                <input type="text" pInputText [value]="profileData.email" disabled
                                                    class="w-full">
                                                <small class="text-600 block mt-1 text-xs md:text-sm">
                                                    <i class="pi pi-lock mr-1"></i>El email no se puede modificar por seguridad
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="flex flex-col sm:flex-row gap-3 mt-4 py-4 border-top-1 surface-border justify-end">
                            <button pButton type="button" label="Cancelar" icon="pi pi-times"
                                class="p-button-outlined p-button-secondary w-full sm:w-auto order-2 sm:order-1" (click)="cancelEdit()"></button>

                            <button pButton type="submit" label="Guardar Cambios" icon="pi pi-check"
                                [disabled]="profileForm.invalid || savingChanges" [loading]="savingChanges"
                                class="w-full sm:w-auto px-4 order-1 sm:order-2"></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        }
    </div>
</div>