<div class="cp-page">
  <p-toast></p-toast>
  <div class="cp-layout">

    <!-- Panel izquierdo: consejos de seguridad -->
    <div class="cp-side-panel">
      <div class="cp-side-inner">
        <div class="cp-side-icon">
          <i class="pi pi-shield"></i>
        </div>
        <h3 class="cp-side-title">Seguridad de tu cuenta</h3>
        <p class="cp-side-desc">Proteger tu cuenta es nuestra prioridad. Sigue estas recomendaciones:</p>

        <ul class="cp-tips-list">
          <li class="cp-tip-item">
            <span class="cp-tip-bullet"><i class="pi pi-check"></i></span>
            <span>Usa al menos 8 caracteres mezclando letras, números y símbolos.</span>
          </li>
          <li class="cp-tip-item">
            <span class="cp-tip-bullet"><i class="pi pi-check"></i></span>
            <span>Evita información personal como tu nombre o fecha de nacimiento.</span>
          </li>
          <li class="cp-tip-item">
            <span class="cp-tip-bullet"><i class="pi pi-check"></i></span>
            <span>No reutilices contraseñas de otras plataformas.</span>
          </li>
          <li class="cp-tip-item">
            <span class="cp-tip-bullet"><i class="pi pi-check"></i></span>
            <span>Cambia tu contraseña regularmente para mayor seguridad.</span>
          </li>
        </ul>

        <div class="cp-side-badge">
          <i class="pi pi-lock"></i>
          <span>Conexión segura SSL</span>
        </div>
      </div>
    </div>

    <!-- Panel derecho: formulario -->
    <div class="cp-form-panel">
      <div class="cp-header">
        <div class="cp-header-icon">
          <i class="pi pi-key"></i>
        </div>
        <div>
          <h2 class="cp-title">Cambiar Contraseña</h2>
          <p class="cp-subtitle">Por favor ingresa tu contraseña actual y define una nueva.</p>
        </div>
      </div>

      <form [formGroup]="changePasswordForm" (ngSubmit)="onSubmit()" class="cp-form">

        <!-- Contraseña Actual -->
        <div class="cp-field">
          <label for="oldPassword" class="cp-label">
            <i class="pi pi-lock-open"></i> Contraseña Actual
          </label>
          <p-password id="oldPassword" formControlName="oldPassword" placeholder="Ingresa tu contraseña actual"
            [toggleMask]="true" [feedback]="false" styleClass="w-full" inputStyleClass="w-full cp-input"
            [class.ng-invalid]="submitted && oldPassword?.invalid" [class.ng-dirty]="submitted && oldPassword?.invalid">
          </p-password>
          <small class="cp-error" *ngIf="submitted && oldPassword?.errors?.['required']">
            <i class="pi pi-exclamation-circle"></i> La contraseña actual es requerida
          </small>
        </div>

        <div class="cp-divider">
          <span>Nueva contraseña</span>
        </div>

        <!-- Nueva Contraseña -->
        <div class="cp-field">
          <label for="newPassword" class="cp-label">
            <i class="pi pi-sync"></i> Nueva Contraseña
          </label>
          <p-password id="newPassword" formControlName="newPassword" placeholder="Mínimo 8 caracteres"
            [toggleMask]="true" [feedback]="false" styleClass="w-full" inputStyleClass="w-full cp-input"
            [class.ng-invalid]="submitted && newPassword?.invalid" [class.ng-dirty]="submitted && newPassword?.invalid">
          </p-password>
          <small class="cp-error" *ngIf="submitted && newPassword?.hasError('required')">
            <i class="pi pi-exclamation-circle"></i> La nueva contraseña es requerida
          </small>
          <small class="cp-error"
            *ngIf="submitted && newPassword?.hasError('minlength') || (submitted && newPassword?.hasError('pattern'))">
            <i class="pi pi-exclamation-circle"></i> La contraseña no cumple los requisitos
          </small>
        </div>

        <!-- Fuerza de la contraseña -->
        <div class="cp-strength-bar-wrap">
          <div class="cp-strength-bar">
            <div class="cp-strength-segment" [class.active]="passwordStrengthCount >= 1"></div>
            <div class="cp-strength-segment" [class.active]="passwordStrengthCount >= 2"></div>
            <div class="cp-strength-segment" [class.active]="passwordStrengthCount >= 3"></div>
            <div class="cp-strength-segment" [class.active]="passwordStrengthCount >= 4"></div>
          </div>
          <span class="cp-strength-label" [ngClass]="passwordStrengthClass">
            {{ passwordStrengthLabel }}
          </span>
        </div>

        <!-- Requisitos -->
        <div class="cp-requirements">
          <div class="cp-req" [class.valid]="hasMinLength()">
            <i class="pi" [ngClass]="hasMinLength() ? 'pi-check-circle' : 'pi-circle'"></i>
            <span>8+ caracteres</span>
          </div>
          <div class="cp-req" [class.valid]="hasUppercase()">
            <i class="pi" [ngClass]="hasUppercase() ? 'pi-check-circle' : 'pi-circle'"></i>
            <span>Mayúscula</span>
          </div>
          <div class="cp-req" [class.valid]="hasNumber()">
            <i class="pi" [ngClass]="hasNumber() ? 'pi-check-circle' : 'pi-circle'"></i>
            <span>Número</span>
          </div>
          <div class="cp-req" [class.valid]="hasSpecialChar()">
            <i class="pi" [ngClass]="hasSpecialChar() ? 'pi-check-circle' : 'pi-circle'"></i>
            <span>Símbolo</span>
          </div>
        </div>

        <!-- Confirmar Contraseña -->
        <div class="cp-field">
          <label for="confirmPassword" class="cp-label">
            <i class="pi pi-check-circle"></i> Confirmar Nueva Contraseña
          </label>
          <p-password id="confirmPassword" formControlName="confirmPassword" placeholder="Repite tu nueva contraseña"
            [toggleMask]="true" [feedback]="false" styleClass="w-full" inputStyleClass="w-full cp-input"
            [class.ng-invalid]="submitted && confirmPassword?.invalid"
            [class.ng-dirty]="submitted && confirmPassword?.invalid">
          </p-password>
          <small class="cp-error" *ngIf="submitted && confirmPassword?.hasError('required')">
            <i class="pi pi-exclamation-circle"></i> Debes confirmar tu nueva contraseña
          </small>
          <small class="cp-error" *ngIf="submitted && confirmPassword?.hasError('passwordMismatch')">
            <i class="pi pi-exclamation-circle"></i> Las contraseñas no coinciden
          </small>
        </div>

        <!-- Info -->
        <div class="cp-info-alert">
          <i class="pi pi-info-circle"></i>
          <span>Tu contraseña debe ser diferente a las últimas 3 utilizadas.</span>
        </div>

        <!-- Botones -->
        <div class="cp-actions">
          <button type="button" class="cp-btn-cancel" (click)="cancel()" [disabled]="loading">
            <i class="pi pi-arrow-left"></i> Volver
          </button>
          <button type="submit" class="cp-btn-submit" [disabled]="loading">
            <i class="pi" [ngClass]="loading ? 'pi-spin pi-spinner' : 'pi-check'"></i>
            {{ loading ? 'Guardando...' : 'Cambiar Contraseña' }}
          </button>
        </div>

      </form>
    </div>

  </div>
</div>