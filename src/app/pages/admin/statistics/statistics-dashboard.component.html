<p-toast></p-toast>

<div class="container mx-auto p-4">
  <h1 class="text-3xl font-bold mb-6">Dashboard de Estadísticas</h1>

  <!-- Spinner de carga -->
  <div *ngIf="loading" class="flex justify-content-center align-items-center" style="height: 400px;">
    <p-progressSpinner strokeWidth="4" animationDuration=".5s"></p-progressSpinner>
  </div>

  <!-- Dashboard principal -->
  <div *ngIf="!loading && dashboardStats" class="w-full">
    <!-- KPIs principales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 w-full">
      <div class="col-span-1">
        <p-card styleClass="h-full shadow-2">
          <ng-template pTemplate="header">
            <div class="bg-primary p-3 text-white font-medium text-center">Usuarios</div>
          </ng-template>
          <div class="text-4xl font-bold text-center py-4">{{ dashboardStats.totalUsers }}</div>
          <div class="text-sm text-center text-500">Total de usuarios registrados</div>
          <div *ngIf="dashboardStats.newUsersLastMonth" class="mt-3 text-center">
            <span class="text-green-500 font-medium">+{{ dashboardStats.newUsersLastMonth }}</span>
            <span class="text-500 ml-1">en el último mes</span>
          </div>
        </p-card>
      </div>

      <div class="col-span-1">
        <p-card styleClass="h-full shadow-2">
          <ng-template pTemplate="header">
            <div class="bg-primary p-3 text-white font-medium text-center">Usuarios Activos</div>
          </ng-template>
          <div class="text-4xl font-bold text-center py-4">{{ dashboardStats.activeUsers }}</div>
          <div class="text-sm text-center text-500">Usuarios activos en el último mes</div>
        </p-card>
      </div>

      <div class="col-span-1">
        <p-card styleClass="h-full shadow-2">
          <ng-template pTemplate="header">
            <div class="bg-primary p-3 text-white font-medium text-center">Cursos</div>
          </ng-template>
          <div class="text-4xl font-bold text-center py-4">{{ dashboardStats.totalCourses }}</div>
          <div class="text-sm text-center text-500">Total de cursos</div>
          <div class="mt-3 text-center">
            <span class="text-500">{{ dashboardStats.totalChapters }} capítulos</span>
          </div>
        </p-card>
      </div>

      <div class="col-span-1">
        <p-card styleClass="h-full shadow-2">
          <ng-template pTemplate="header">
            <div class="bg-primary p-3 text-white font-medium text-center">Calificación Promedio</div>
          </ng-template>
          <div class="text-4xl font-bold text-center py-4">{{ dashboardStats.avgScore }}</div>
          <div class="text-sm text-center text-500">Promedio global</div>
        </p-card>
      </div>
    </div>

    <!-- Selector de período -->
    <div class="col-12 flex justify-content-end align-items-center my-4">
      <div class="p-inputgroup w-full md:w-4">
        <span class="p-inputgroup-addon">Período:</span>
        <p-dropdown [options]="periodOptions" [(ngModel)]="selectedPeriod" (onChange)="onPeriodChange()" optionLabel="label" optionValue="value" styleClass="w-full"></p-dropdown>
      </div>
    </div>

    <!-- Gráficos de tendencias -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
      <div class="col-span-1">
        <p-card styleClass="shadow-1 h-full">
          <ng-template pTemplate="header">
            <div class="bg-blue-50 p-3 font-medium text-blue-800 text-xl text-center">Nuevos Usuarios</div>
          </ng-template>
          <div class="p-2">
            <p-chart *ngIf="usersGrowthData" type="line" [data]="usersGrowthData" [options]="chartOptions" height="300px"></p-chart>
            <div *ngIf="!usersGrowthData" class="flex justify-content-center align-items-center" style="height: 300px;">
              <p-progressSpinner strokeWidth="4" animationDuration=".5s"></p-progressSpinner>
            </div>
          </div>
        </p-card>
      </div>

      <div class="col-span-1">
        <p-card styleClass="shadow-1 h-full">
          <ng-template pTemplate="header">
            <div class="bg-blue-50 p-3 font-medium text-blue-800 text-xl text-center">Usuarios Activos</div>
          </ng-template>
          <div class="p-2">
            <p-chart *ngIf="activeUsersData" type="line" [data]="activeUsersData" [options]="chartOptions" height="300px"></p-chart>
            <div *ngIf="!activeUsersData" class="flex justify-content-center align-items-center" style="height: 300px;">
              <p-progressSpinner strokeWidth="4" animationDuration=".5s"></p-progressSpinner>
            </div>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Pestañas para diferentes categorías de estadísticas -->
    <div class="col-12 mt-4">
      <p-tabView styleClass="statistics-tabs">
        <!-- Pestaña de Usuarios -->
        <p-tabPanel header="Usuarios">
          <div class="grid">
            <div class="col-12 lg:col-6 p-2">
              <p-card styleClass="shadow-1 h-full">
                <ng-template pTemplate="header">
                  <div class="bg-blue-50 p-3 font-medium text-blue-800 text-xl text-center">Distribución por Tipo de Usuario</div>
                </ng-template>
                <div class="p-3">
                  <p-chart *ngIf="usersByTypeData" type="pie" [data]="usersByTypeData" [options]="chartOptions" height="300px"></p-chart>
                  <div *ngIf="!usersByTypeData" class="flex justify-content-center align-items-center" style="height: 300px;">
                    <p-progressSpinner strokeWidth="4" animationDuration=".5s"></p-progressSpinner>
                  </div>
                </div>
              </p-card>
            </div>

            <div class="col-12 lg:col-6 p-2">
              <p-card styleClass="shadow-1 h-full">
                <ng-template pTemplate="header">
                  <div class="bg-blue-50 p-3 font-medium text-blue-800 text-xl text-center">Top Usuarios</div>
                </ng-template>
                <div class="p-3">
                  <p-table *ngIf="dashboardStats?.topUsers && dashboardStats.topUsers.length > 0" [value]="dashboardStats.topUsers" 
                          [paginator]="true" [rows]="5" styleClass="p-datatable-sm">
                    <ng-template pTemplate="header">
                      <tr>
                        <th>Usuario</th>
                        <th class="text-right">Puntuación</th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-user>
                      <tr>
                        <td>{{ user.firstName }} {{ user.lastName }}</td>
                        <td class="text-right font-bold">{{ user.score }}</td>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                      <tr>
                        <td colspan="2" class="text-center p-4">No hay datos disponibles</td>
                      </tr>
                    </ng-template>
                  </p-table>
                  <div *ngIf="!dashboardStats?.topUsers || dashboardStats.topUsers.length === 0" class="p-4 text-center text-500">
                    No hay datos de usuarios disponibles
                  </div>
                </div>
              </p-card>
            </div>
          </div>
        </p-tabPanel>
      </p-tabView>
    </div>
  </div>
</div>
