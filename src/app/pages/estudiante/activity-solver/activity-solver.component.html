<p-toast></p-toast>
<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

<!-- Spinner de carga inicial -->
<div *ngIf="loading()" class="flex justify-content-center align-items-center" style="height: 80vh;">
  <div class="spinner-container">
    <div class="spinner"></div>
  </div>
</div>

<!-- Contenido principal - Diseño Duolingo -->
<div class="h-full inset-0 absolute bg-gradient-to-br from-blue-50 to-indigo-100 flex flex-col">

  <!-- Barra de progreso superior -->
  <div class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
    <div class="max-w-4xl mx-auto">
      <!-- Contador de ejercicios (arriba, centrado) -->

      <div class="flex flex-col items-center justify-center mb-3">
        <span class="text-sm font-medium text-gray-600">
          Ejercicio {{ currentExerciseIndex() + 1 }} de {{ safeActivity.exercises.length }}
        </span>
      </div>

      <!-- Fila principal con botón, barra de progreso y tumis -->
      <div class="flex items-center justify-between h-12">
        
        <!-- Botón de retroceso -->
        <div class="flex items-center h-full">
          <p-button icon="pi pi-arrow-left"
                   styleClass="p-button-rounded p-button-text p-button-secondary h-10 w-10 flex items-center justify-center"
                   (click)="navigateBack()"
                   pTooltip="Volver atrás" 
                   tooltipPosition="bottom">
          </p-button>
        </div>

        <!-- Barra de progreso (ocupa el espacio disponible) -->
        <div class="flex-grow mx-4 h-full flex flex-col justify-center">
          <p-progressBar [value]="progress" [showValue]="false" styleClass="h-2 bg-gray-200"></p-progressBar>
        </div>

        <!-- Indicador de Tumis (vidas) -->
        <div class="flex items-center h-full">
          <div class="flex items-center gap-2 bg-gradient-to-r from-red-50 to-pink-50 px-4 py-2 rounded-full border border-red-200 shadow-sm h-10">
            <i class="pi pi-heart-fill text-red-500 text-xl"></i>
            <span class="text-red-700 font-semibold text-lg">{{ safeUserIndicators.tumis }}</span>
            <span class="text-red-600 text-sm font-medium">tumis</span>
          </div>
        </div>

      </div>

      <div class="flex flex-col items-center justify-center mb-3">
        <span class="text-xs text-gray-500">
          {{ progress.toFixed(0) }}% completado
        </span>
      </div>


    </div>
  </div>

  <!-- Contenido del ejercicio con scroll automático -->
  <div class="flex-1 px-6 py-1 overflow-y-auto">
    <div class="flex justify-center">
      <div class="w-[98%] sm:w-[90%] md:w-[80%] lg:w-[70%] max-w-none py-1">
      <div *ngIf="currentExercise" class="bg-white rounded-2xl shadow-xl">
        <div class="p-8">
        <div class="mb-6">
          <h2 class="text-2xl font-bold text-slate-800 mb-4">{{ currentExercise.statement }}</h2>
          
          <!-- Pista del ejercicio -->
          <div *ngIf="currentExercise.hind" class="bg-blue-50 p-4 rounded-lg mb-6 border-l-4 border-blue-500">
            <div class="flex items-start gap-3">
              <i class="pi pi-info-circle text-blue-500 text-xl mt-1"></i>
              <div>
                <h3 class="text-lg font-semibold text-blue-700 mb-1">Pista</h3>
                <p class="text-blue-800">{{ currentExercise.hind }}</p>
              </div>
            </div>
          </div>
          
          <!-- Código del ejercicio (si existe) -->
          <div *ngIf="currentExercise.code" class="bg-slate-800 text-white p-4 rounded-lg mb-6 overflow-x-auto">
            <pre class="whitespace-pre-wrap"><code>{{ currentExercise.code }}</code></pre>
          </div>
        </div>
        
        <!-- Componente específico según el tipo de ejercicio -->
        <div [ngSwitch]="currentExercise.typeExercise" class="mb-6">
          <app-single-selection-exercise 
            *ngSwitchCase="'selection_single'"
            [options]="currentExercise.optionSelectOptions"
            [selectedOption]="answers()[currentExerciseIndex()] ? answers()[currentExerciseIndex()].answerSelect : undefined"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-single-selection-exercise>
          
          <app-multiple-selection-exercise 
            *ngSwitchCase="'selection_multiple'"
            [options]="currentExercise.optionSelectOptions"
            [selectedOptions]="answers()[currentExerciseIndex()] ? answers()[currentExerciseIndex()].answerSelects : []"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-multiple-selection-exercise>
          
          <app-order-fragment-code-exercise 
            *ngSwitchCase="'order_fragment_code'"
            [fragments]="currentExercise.optionOrderFragmentCode"
            [orderedFragments]="answers()[currentExerciseIndex()] ? answers()[currentExerciseIndex()].answerOrderFragmentCode : []"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-order-fragment-code-exercise>
          
          <app-order-line-code-exercise 
            *ngSwitchCase="'order_line_code'"
            [lines]="currentExercise.optionOrderLineCode"
            [orderedLines]="answers()[currentExerciseIndex()] ? answers()[currentExerciseIndex()].answerOrderLineCode : []"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-order-line-code-exercise>
          
          <app-write-code-exercise 
            *ngSwitchCase="'write_code'"
            [code]="answers()[currentExerciseIndex()] ? answers()[currentExerciseIndex()].answerWriteCode : ''"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-write-code-exercise>
          
          <app-find-error-code-exercise 
            *ngSwitchCase="'find_error_code'"
            [options]="currentExercise.optionFindErrorCode"
            [selectedError]="answers()[currentExerciseIndex()] ? answers()[currentExerciseIndex()].answerFindError : undefined"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-find-error-code-exercise>

          <app-vertical-ordering-exercise 
            *ngSwitchCase="'vertical_ordering'"
            [fragments]="currentExercise.optionsVerticalOrdering"
            [orderedFragments]="answers()[currentExerciseIndex()].answerVerticalOrdering || []"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-vertical-ordering-exercise>

          <app-horizontal-ordering-exercise 
            *ngSwitchCase="'horizontal_ordering'"
            [lines]="currentExercise.optionsHorizontalOrdering"
            [orderedLines]="answers()[currentExerciseIndex()].answerHorizontalOrdering || []"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-horizontal-ordering-exercise>

          <app-phishing-selection-multiple-exercise 
            *ngSwitchCase="'phishing_selection_multiple'"
            [options]="currentExercise.optionsPhishingSelection"
            [selectedOptions]="answers()[currentExerciseIndex()].answerPhishingSelection || []"
            [phishingContext]="currentExercise.phishingContext"
            [phishingImageUrl]="currentExercise.phishingImageUrl"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-phishing-selection-multiple-exercise>

          <app-match-pairs-exercise 
            *ngSwitchCase="'match_pairs'"
            [leftOptions]="currentExercise.optionsMatchPairsLeft"
            [rightOptions]="currentExercise.optionsMatchPairsRight"
            [matchedPairs]="answers()[currentExerciseIndex()].answerMatchPairs || []"
            (answerSubmitted)="onAnswerSubmitted($event)">
          </app-match-pairs-exercise>
        </div>
        
        </div>
        
        <!-- Botones de acción -->
        <div class="flex justify-center mt-8 mb-8">
          <!-- Botón Verificar Respuesta (antes de verificar) -->
          <div *ngIf="!answerVerified()" class="flex gap-4 mb-8">
            <p-button
              label="Verificar Respuesta"
              icon="pi pi-check"
              styleClass="p-button-primary px-8 py-3 text-lg"
              (onClick)="verifyAnswer()"
              [loading]="submitting()"
              [disabled]="!hasAnswer()">
            </p-button>
          </div>

          <!-- Botones Siguiente/Anterior (después de verificar) -->
          <div *ngIf="answerVerified()" class="flex gap-4 mb-8">
            <p-button
              *ngIf="!isFirstExercise"
              label="Anterior"
              icon="pi pi-arrow-left"
              styleClass="p-button-secondary"
              (onClick)="previousExercise()">
            </p-button>

            <p-button
              [label]="isLastExercise ? 'Finalizar Actividad' : 'Siguiente'"
              [icon]="isLastExercise ? 'pi pi-check' : 'pi pi-arrow-right'"
              [styleClass]="isLastExercise ? 'p-button-success' : 'p-button-primary'"
              (onClick)="nextExercise()"
              [loading]="submitting()">
            </p-button>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Drawer de Feedback -->
<p-drawer
  [(visible)]="showFeedbackDrawer"
  [modal]="true"
  position="bottom"
  [style]="{'height': 'auto', 'border-radius': '16px 16px 0 0'}"
  [contentStyle]="{'padding': '0', 'border-radius': '16px 16px 0 0'}"
  [styleClass]="'feedback-drawer'"
  [showHeader]="false"
  [dismissible]="true"
  (onHide)="closeFeedbackDrawer()">

  <!-- Contenido del drawer de feedback -->
  <div class="feedback-drawer-content" *ngIf="showFeedback() && currentFeedback()">
    <!-- Handle para arrastrar -->
    <div class="flex justify-center py-2">
      <div class="w-16 h-1 bg-gray-300 rounded-full"></div>
    </div>

    <div class="flex justify-center flex flex-col md:flex-row">
      <!-- Contenido principal -->
      <div class="justify-center w-full md:w-[70%] px-4 py-6">
        <div [ngClass]="{
          'bg-green-50 border-green-200': safeFeedback.qualification >= 7, 
          'bg-amber-50 border-amber-200': safeFeedback.qualification >= 5 && safeFeedback.qualification < 7, 
          'bg-red-50 border-red-200': safeFeedback.qualification < 5
        }" class="rounded-xl border p-6 shadow-sm">
          
          <div class="flex flex-col md:flex-row gap-1">
            <!-- Columna Izquierda: Ícono -->
            <div class="flex items-center justify-center">
              <div [ngClass]="{
                'bg-green-100 text-green-600': safeFeedback.qualification >= 7, 
                'bg-amber-100 text-amber-600': safeFeedback.qualification >= 5 && safeFeedback.qualification < 7, 
                'bg-red-100 text-red-600': safeFeedback.qualification < 5
              }" class="p-4 rounded-xl">
                <i [ngClass]="{
                  'pi-check-circle': safeFeedback.qualification >= 7, 
                  'pi-exclamation-circle': safeFeedback.qualification >= 5 && safeFeedback.qualification < 7, 
                  'pi-times-circle': safeFeedback.qualification < 5
                }" class="pi text-4xl"></i>
              </div>
            </div>

            <!-- Columna Central: Contenido -->
            <div class="flex-1">
              <h3 [ngClass]="{
                'text-green-800': safeFeedback.qualification >= 7, 
                'text-amber-800': safeFeedback.qualification >= 5 && safeFeedback.qualification < 7, 
                'text-red-800': safeFeedback.qualification < 5
              }" class="text-2xl font-bold mb-1">
                {{ safeFeedback.qualification >= 7 ? '¡Excelente trabajo!' : safeFeedback.qualification >= 5 ? 'Buen intento' : 'Revisa el concepto' }}
              </h3>
              <p class="text-gray-600 mb-1">
                {{ safeFeedback.qualification >= 7 ? '¡Sigue así!' : safeFeedback.qualification >= 5 ? 'Estás cerca de dominarlo' : 'Necesitas practicar más' }}
              </p>
              
              <!-- Puntuación -->
              <div class="mb-1">
                <span class="text-sm text-gray-600">Tu puntuación:</span>
                <span [ngClass]="{
                  'text-green-600': safeFeedback.qualification >= 7, 
                  'text-amber-600': safeFeedback.qualification >= 5 && safeFeedback.qualification < 7, 
                  'text-red-600': safeFeedback.qualification < 5
                }" class="ml-2 text-xl font-bold">
                  {{ safeFeedback.qualification }}/10
                </span>
              </div>

              <!-- Botón de retroalimentación detallada -->
              <button 
                (click)="showAIFeedbackModal.set(true)" 
                class="p-2 text-sm font-medium rounded-lg flex items-center gap-2 transition-all"
                [ngClass]="{
                  'text-green-700 hover:bg-green-100': safeFeedback.qualification >= 7, 
                  'text-amber-700 hover:bg-amber-100': safeFeedback.qualification >= 5 && safeFeedback.qualification < 7, 
                  'text-red-700 hover:bg-red-100': safeFeedback.qualification < 5
                }">
                <i class="pi pi-info-circle"></i>
                <span>Ver retroalimentación detallada</span>
                <i class="pi pi-chevron-right ml-1"></i>
              </button>
            </div>

            <!-- Columna Derecha: Botones de acción -->
            <div class="flex flex-col gap-3 w-full md:w-48">
              <button
                pButton
                label="Revisar respuesta"
                icon="pi pi-eye"
                class="p-button-outlined p-button-secondary"
                (click)="closeFeedbackDrawer()">
              </button>
              
              <button
                pButton
                [label]="isLastExercise ? 'Finalizar' : 'Siguiente'"
                [icon]="isLastExercise ? 'pi pi-check' : 'pi pi-arrow-right'"
                [iconPos]="'right'"
                [class]="isLastExercise ? 'p-button-success' : 'p-button-primary'"
                (click)="isLastExercise ? finishActivity() : continueFromFeedback()">
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</p-drawer>

<!-- Modal de Feedback de IA -->
<p-dialog
  [(visible)]="showAIFeedbackModal"
  [modal]="true"
  [style]="{width: '90vw', maxWidth: '900px'}"
  [contentStyle]="{'padding': '0', 'border-radius': '16px', 'overflow': 'hidden', 'box-shadow': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)'}"
  [closeOnEscape]="true"
  [dismissableMask]="true"
  [closable]="false"
  [breakpoints]="{'960px': '95vw', '640px': '98vw'}"
  styleClass="ai-feedback-modal">
  
  <!-- Header del modal con botón de cerrar -->
  <ng-template pTemplate="header">
    <div class="bg-gradient-to-r from-blue-600 to-blue-500 px-6 py-5 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <i class="pi pi-robot text-white text-xl"></i>
        <h2 class="text-lg font-semibold text-white m-0">Retroalimentación detallada</h2>
      </div>
      <button 
        type="button" 
        (click)="showAIFeedbackModal.set(false)" 
        class="text-white hover:bg-white/10 p-2 rounded-full transition-colors">
        <i class="pi pi-times"></i>
      </button>
    </div>
  </ng-template>
  
  <!-- Contenido del modal -->
  <div class="flex flex-col md:flex-row bg-white">
    <!-- Lado izquierdo - Imagen -->
    <div class="w-full md:w-2/5 bg-gradient-to-b from-blue-50 to-white p-8 flex flex-col items-center justify-center">
      <div class="relative w-full max-w-xs">
        <div class="absolute -top-6 -left-6 w-32 h-32 bg-blue-100 rounded-full opacity-50"></div>
        <div class="absolute -bottom-6 -right-6 w-32 h-32 bg-indigo-100 rounded-full opacity-50"></div>
        <div class="relative z-10">
          <img 
            src="https://i.ibb.co/Zz3XV6xj/amauta.png" 
            alt="Retroalimentación de IA" 
            class="w-full h-auto max-h-64 object-contain"
            onerror="this.src='assets/images/placeholder-feedback.svg'"
          >
        </div>
      </div>
      <div class="mt-8 text-center">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Análisis detallado</h3>
        <p class="text-gray-600 text-sm">Esta retroalimentación ha sido generada automáticamente para ayudarte a mejorar.</p>
      </div>
    </div>
    
    <!-- Lado derecho - Feedback de IA -->
    <div class="w-full md:w-3/5 p-8 max-h-[70vh] overflow-y-auto">
      <div class="prose max-w-none">
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg mb-6">
          <div class="flex items-start gap-3">
            <i class="pi pi-lightbulk text-blue-600 mt-1"></i>
            <div>
              <h4 class="text-blue-800 font-medium mb-1">Consejo del sistema</h4>
              <p class="text-blue-700 text-sm">Revisa detenidamente la retroalimentación para mejorar en los siguientes ejercicios.</p>
            </div>
          </div>
        </div>
        
        <div class="prose prose-blue max-w-none" [innerHTML]="safeFeedback.feedback"></div>
        
        <div class="mt-8 pt-6 border-t border-gray-200">
          <div class="flex items-center gap-3">
            <div class="bg-blue-100 text-blue-600 p-2 rounded-full">
              <i class="pi pi-thumbs-up"></i>
            </div>
            <p class="text-sm text-gray-600">¿Te resultó útil esta retroalimentación?</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Footer del modal -->
  <ng-template pTemplate="footer">
    <div class="flex justify-end p-4 border-t border-gray-200 bg-gray-50">
      <button 
        pButton 
        type="button" 
        label="Cerrar" 
        icon="pi pi-check"
        class="p-button-text" 
        (click)="showAIFeedbackModal.set(false)">
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Modal de resultados de actividad completada -->
<p-dialog
  [(visible)]="showResultsModal"
  [modal]="true"
  [closeOnEscape]="false"
  [closable]="false"
  [draggable]="false"
  [resizable]="false"
  [style]="{width: '100vw', height: '100vh', 'max-width': '100vw', 'max-height': '100vh'}"
  [contentStyle]="{'height': '100%', 'padding': '0'}"
  [maskStyle]="{'background-color': 'rgba(0, 0, 0, 0.8)'}"
  styleClass="fullscreen-results-modal">

  <!-- Contenido del modal -->
  <div class="results-modal-content">
    <div class="text-center py-12 px-6">
      <div class="mb-12">
        <div class="flex justify-center mb-6">
          <div class="w-32 h-32 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center shadow-2xl">
            <i class="pi pi-check-circle text-white text-6xl"></i>
          </div>
        </div>

        <h1 class="text-5xl font-bold text-slate-900 mb-4">¡Actividad completada!</h1>
        <p class="text-2xl text-slate-600">Has completado la actividad "{{ safeActivityResult.activity }}"</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12 max-w-4xl mx-auto">
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-8 rounded-2xl shadow-xl border border-blue-200">
          <div class="text-blue-600 text-5xl font-bold mb-3">{{ safeActivityResult.score }}</div>
          <div class="text-blue-700 font-semibold text-lg">Puntuación total</div>
        </div>

        <div class="bg-gradient-to-br from-green-50 to-green-100 p-8 rounded-2xl shadow-xl border border-green-200">
          <div class="text-green-600 text-5xl font-bold mb-3">{{ safeActivityResult.accuracy }}%</div>
          <div class="text-green-700 font-semibold text-lg">Precisión</div>
        </div>

        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-8 rounded-2xl shadow-xl border border-amber-200">
          <div class="text-amber-600 text-5xl font-bold mb-3">+{{ safeActivityResult.gems }}</div>
          <div class="text-amber-700 font-semibold text-lg">Yachay ganados</div>
        </div>
      </div>

      <div class="flex flex-col md:flex-row justify-center gap-6">
        <p-button
          label="Volver a los temas"
          icon="pi pi-arrow-left"
          styleClass="p-button-secondary p-button-lg px-8 py-4 text-lg"
          (onClick)="navigateBack()">
        </p-button>

        <p-button
          label="Reintentar actividad"
          icon="pi pi-refresh"
          styleClass="p-button-primary p-button-lg px-8 py-4 text-lg"
          (onClick)="restartActivity()">
        </p-button>
      </div>
    </div>
  </div>
</p-dialog>
