<p-toast></p-toast>

<div class="container mx-auto p-4">
  <h1 class="text-3xl font-bold mb-6">Dashboard de Estadísticas</h1>

  <!-- Spinner de carga -->
  <div *ngIf="loading" class="flex justify-content-center align-items-center" style="height: 400px;">
    <p-progressSpinner strokeWidth="4" animationDuration=".5s"></p-progressSpinner>
  </div>

  <!-- Dashboard principal -->
  <div *ngIf="!loading && dashboardStats" class="w-full">
    <!-- KPIs principales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 w-full">
      <div class="col-span-1">
        <p-card styleClass="h-full shadow-2">
          <ng-template pTemplate="header">
            <div class="bg-blue-600 p-3 text-white font-medium text-center">Estudiantes</div>
          </ng-template>
          <div class="text-4xl font-bold text-center py-4 text-blue-600">{{ dashboardStats.totalStudents }}</div>
          <div class="text-sm text-center text-500">Total de estudiantes</div>
          <div *ngIf="dashboardStats.newUsersLastMonth" class="mt-3 text-center">
            <span class="text-green-500 font-medium">+{{ dashboardStats.newUsersLastMonth }}</span>
            <span class="text-500 ml-1">en el último mes</span>
          </div>
        </p-card>
      </div>

      <div class="col-span-1">
        <p-card styleClass="h-full shadow-2">
          <ng-template pTemplate="header">
            <div class="bg-green-600 p-3 text-white font-medium text-center">Profesores</div>
          </ng-template>
          <div class="text-4xl font-bold text-center py-4 text-green-600">{{ dashboardStats.totalTeachers }}</div>
          <div class="text-sm text-center text-500">Total de profesores</div>
          <div *ngIf="dashboardStats.totalAdmins" class="mt-3 text-center">
            <span class="text-purple-600 font-medium">{{ dashboardStats.totalAdmins }}</span>
            <span class="text-500 ml-1">administradores</span>
          </div>
        </p-card>
      </div>

      <div class="col-span-1">
        <p-card styleClass="h-full shadow-2">
          <ng-template pTemplate="header">
            <div class="bg-orange-600 p-3 text-white font-medium text-center">Cursos</div>
          </ng-template>
          <div class="text-4xl font-bold text-center py-4 text-orange-600">{{ dashboardStats.totalCourses }}</div>
          <div class="text-sm text-center text-500">Total de cursos</div>
          <div class="mt-3 text-center">
            <span class="text-500">{{ dashboardStats.totalChapters }} capítulos</span>
          </div>
        </p-card>
      </div>

      <div class="col-span-1">
        <p-card styleClass="h-full shadow-2">
          <ng-template pTemplate="header">
            <div class="bg-purple-600 p-3 text-white font-medium text-center">Calificación Promedio</div>
          </ng-template>
          <div class="text-4xl font-bold text-center py-4 text-purple-600">{{ dashboardStats.avgScore }}</div>
          <div class="text-sm text-center text-500">Promedio global</div>
        </p-card>
      </div>
    </div>

    <!-- Selector de período -->
    <div class="col-12 flex justify-content-end align-items-center my-4">
      <div class="p-inputgroup w-full md:w-4">
        <span class="p-inputgroup-addon">Período:</span>
        <p-dropdown [options]="periodOptions" [(ngModel)]="selectedPeriod" (onChange)="onPeriodChange()" optionLabel="label" optionValue="value" styleClass="w-full"></p-dropdown>
      </div>
    </div>

    <!-- Gráficos de tendencias -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 w-full">
      <div class="col-span-1">
        <p-card styleClass="shadow-1 h-full">
          <ng-template pTemplate="header">
            <div class="bg-blue-50 p-3 font-medium text-blue-800 text-xl text-center">Nuevos Usuarios</div>
          </ng-template>
          <div class="p-2">
            <p-chart *ngIf="usersGrowthData" type="line" [data]="usersGrowthData" [options]="chartOptions" height="300px"></p-chart>
            <div *ngIf="!usersGrowthData" class="flex justify-content-center align-items-center" style="height: 300px;">
              <p-progressSpinner strokeWidth="4" animationDuration=".5s"></p-progressSpinner>
            </div>
          </div>
        </p-card>
      </div>

      <div class="col-span-1">
        <p-card styleClass="shadow-1 h-full">
          <ng-template pTemplate="header">
            <div class="bg-blue-50 p-3 font-medium text-blue-800 text-xl text-center">Usuarios Activos</div>
          </ng-template>
          <div class="p-2">
            <p-chart *ngIf="activeUsersData" type="line" [data]="activeUsersData" [options]="chartOptions" height="300px"></p-chart>
            <div *ngIf="!activeUsersData" class="flex justify-content-center align-items-center" style="height: 300px;">
              <p-progressSpinner strokeWidth="4" animationDuration=".5s"></p-progressSpinner>
            </div>
          </div>
        </p-card>
      </div>

      <div class="col-span-1">
        <p-card styleClass="shadow-1 h-full">
          <ng-template pTemplate="header">
            <div class="bg-purple-50 p-3 font-medium text-purple-800 text-xl text-center">Temas Completados</div>
          </ng-template>
          <div class="p-2">
            <p-chart *ngIf="temasCompletionData" type="line" [data]="temasCompletionData" [options]="chartOptions" height="300px"></p-chart>
            <div *ngIf="!temasCompletionData" class="flex justify-content-center align-items-center" style="height: 300px;">
              <p-progressSpinner strokeWidth="4" animationDuration=".5s"></p-progressSpinner>
            </div>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Pestañas para diferentes categorías de estadísticas -->
    <div class="col-12 mt-4">
      <p-tabView styleClass="statistics-tabs">
        <!-- Pestaña de Usuarios -->
        <p-tabPanel header="Usuarios">
          <div class="grid">
            <div class="col-12 p-2">
              <p-card styleClass="shadow-1 h-full">
                <ng-template pTemplate="header">
                  <div class="bg-blue-50 p-3 font-medium text-blue-800 text-xl text-center">Distribución por Tipo de Usuario</div>
                </ng-template>
                <div class="p-3">
                  <p-chart *ngIf="usersByTypeData" type="pie" [data]="usersByTypeData" [options]="chartOptions" height="300px"></p-chart>
                  <div *ngIf="!usersByTypeData" class="flex justify-content-center align-items-center" style="height: 300px;">
                    <p-progressSpinner strokeWidth="4" animationDuration=".5s"></p-progressSpinner>
                  </div>
                </div>
              </p-card>
            </div>
          </div>
        </p-tabPanel>
      </p-tabView>
    </div>
  </div>
</div>
