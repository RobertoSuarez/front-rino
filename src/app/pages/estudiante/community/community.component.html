<div class="community-container">
  <!-- Header -->
  <div class="community-header">
    <div class="header-content">
      <h1 class="page-title">Comunidad</h1>
      <p class="page-subtitle">Conecta con otros estudiantes de ciberseguridad</p>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <i class="pi pi-users"></i>
        </div>
        <div class="stat-info">
          <div class="stat-number">{{ friends.length }}</div>
          <div class="stat-label">Amigos</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">
          <i class="pi pi-user-plus"></i>
        </div>
        <div class="stat-info">
          <div class="stat-number">{{ friendRequests.length }}</div>
          <div class="stat-label">Solicitudes</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">
          <i class="pi pi-circle-fill online-indicator"></i>
        </div>
        <div class="stat-info">
          <div class="stat-number">{{ getOnlineFriends().length }}</div>
          <div class="stat-label">En línea</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button
      pButton
      type="button"
      [label]="'Descubrir Usuarios'"
      class="tab-button"
      [class.active]="activeTab === 'discover'"
      (click)="setActiveTab('discover')"
      icon="pi pi-search">
    </button>
    <button
      pButton
      type="button"
      [label]="'Mis Amigos'"
      class="tab-button"
      [class.active]="activeTab === 'friends'"
      (click)="setActiveTab('friends')"
      icon="pi pi-heart">
    </button>
  </div>

  <!-- Discover Users Tab -->
  <div *ngIf="activeTab === 'discover'" class="tab-content">
    <!-- Search Bar -->
    <div class="search-section">
      <div class="p-field">
        <label for="search">Buscar usuarios</label>
        <input
          pInputText
          id="search"
          [(ngModel)]="searchQuery"
          placeholder="Buscar por nombre, usuario o biografía..."
          class="search-input">
      </div>
    </div>

    <!-- Friend Requests Section -->
    <div *ngIf="friendRequests.length > 0" class="friend-requests-section">
      <h3>Solicitudes de amistad ({{ friendRequests.length }})</h3>
      <div class="requests-grid">
        <div *ngFor="let request of friendRequests" class="request-card">
          <div class="request-user">
            <p-avatar
              [image]="request.fromUser.avatar"
              size="large"
              shape="circle"
              styleClass="request-avatar">
            </p-avatar>
            <div class="request-info">
              <h4>{{ request.fromUser.name }}</h4>
              <p class="request-username">@{{ request.fromUser.username }}</p>
              <p class="request-message" *ngIf="request.message">{{ request.message }}</p>
              <small class="request-date">{{ formatDate(request.requestDate) }}</small>
            </div>
          </div>
          <div class="request-actions">
            <button
              class="accept-button"
              (click)="acceptFriendRequest(request)">
              <i class="pi pi-check"></i>
              <span>Aceptar</span>
            </button>
            <button
              class="reject-button"
              (click)="rejectFriendRequest(request)">
              <i class="pi pi-times"></i>
              <span>Rechazar</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Users Grid -->
    <div class="users-section">
      <h3>Usuarios disponibles ({{ getFilteredUsers().length }})</h3>
      <div *ngIf="isLoading" class="loading-state">
        <div class="loading-spinner">
          <i class="pi pi-spin pi-spinner" style="font-size: 2rem;"></i>
          <p>Cargando usuarios...</p>
        </div>
      </div>

      <div *ngIf="!isLoading && getFilteredUsers().length === 0" class="empty-state">
        <div class="empty-icon">
          <i class="pi pi-users"></i>
        </div>
        <h3>No se encontraron usuarios</h3>
        <p>Intenta con una búsqueda diferente</p>
      </div>

      <div *ngIf="!isLoading && getFilteredUsers().length > 0" class="users-grid">
        <div *ngFor="let user of getFilteredUsers()" class="user-card">
          <div class="user-header">
            <div class="user-avatar-section">
              <p-avatar
                [image]="user.avatar"
                size="large"
                shape="circle"
                styleClass="user-avatar">
              </p-avatar>
              <div *ngIf="user.isOnline" class="online-status">
                <i class="pi pi-circle-fill"></i>
              </div>
            </div>
            <div class="user-actions">
              <p-button
                *ngIf="user.friendStatus === 'none'"
                label="Agregar amigo"
                icon="pi pi-user-plus"
                class="p-button-primary p-button-sm"
                (click)="sendFriendRequest(user)">
              </p-button>
              <p-button
                *ngIf="user.friendStatus === 'pending'"
                label="Solicitud enviada"
                icon="pi pi-clock"
                class="p-button-secondary p-button-sm"
                disabled="true">
              </p-button>
              <p-button
                *ngIf="user.friendStatus === 'accepted'"
                label="Amigo"
                icon="pi pi-heart"
                class="p-button-success p-button-sm"
                disabled="true">
              </p-button>
            </div>
          </div>

          <div class="user-info">
            <h4 class="user-name">{{ user.name }}</h4>
            <p class="user-username">@{{ user.username }}</p>

            <div class="user-level" [style.color]="getUserLevelColor(user.level)">
              <i class="pi pi-star-fill"></i>
              <span>Nivel {{ user.level }} - {{ getUserLevelLabel(user.level) }}</span>
            </div>

            <div class="user-stats">
              <div class="stat-item">
                <span class="stat-value">{{ user.experience }}</span>
                <span class="stat-label">XP</span>
              </div>
              <div class="stat-item">
                <span class="stat-value">{{ user.achievements }}</span>
                <span class="stat-label">Logros</span>
              </div>
              <div class="stat-item">
                <span class="stat-value">{{ user.coursesCompleted }}</span>
                <span class="stat-label">Cursos</span>
              </div>
            </div>

            <p *ngIf="user.bio" class="user-bio">{{ user.bio }}</p>
            <p *ngIf="user.location" class="user-location">
              <i class="pi pi-map-marker"></i> {{ user.location }}
            </p>

            <div class="user-actions-bottom">
              <p-button
                label="Ver perfil"
                icon="pi pi-eye"
                class="p-button-text p-button-sm"
                (click)="viewUserProfile(user)">
              </p-button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Friends Tab -->
  <div *ngIf="activeTab === 'friends'" class="tab-content">
    <!-- Online Friends -->
    <div *ngIf="getOnlineFriends().length > 0" class="friends-section">
      <h3>En línea ({{ getOnlineFriends().length }})</h3>
      <div class="friends-grid">
        <div *ngFor="let friend of getOnlineFriends()" class="friend-card">
          <div class="friend-avatar">
            <p-avatar
              [image]="friend.user.avatar"
              size="large"
              shape="circle">
            </p-avatar>
            <div class="online-indicator">
              <i class="pi pi-circle-fill"></i>
            </div>
          </div>
          <div class="friend-info">
            <h4>{{ friend.user.name }}</h4>
            <p>@{{ friend.user.username }}</p>
            <small>{{ getFriendshipDuration(friend.friendshipDate) }}</small>
          </div>
          <div class="friend-actions">
            <button
              class="view-profile-button"
              (click)="viewUserProfile(friend.user)">
              <i class="pi pi-eye"></i>
              <span>Ver perfil</span>
            </button>
            <button
              class="remove-friend-button"
              (click)="removeFriend(friend)">
              <i class="pi pi-trash"></i>
              <span>Eliminar</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Offline Friends -->
    <div *ngIf="getOfflineFriends().length > 0" class="friends-section">
      <h3>Todos los amigos ({{ friends.length }})</h3>
      <div class="friends-grid">
        <div *ngFor="let friend of friends" class="friend-card">
          <div class="friend-avatar">
            <p-avatar
              [image]="friend.user.avatar"
              size="large"
              shape="circle">
            </p-avatar>
            <div class="offline-indicator">
              <i class="pi pi-circle"></i>
            </div>
          </div>
          <div class="friend-info">
            <h4>{{ friend.user.name }}</h4>
            <p>@{{ friend.user.username }}</p>
            <small>{{ getFriendshipDuration(friend.friendshipDate) }}</small>
          </div>
          <div class="friend-actions">
            <button
              class="view-profile-button"
              (click)="viewUserProfile(friend.user)">
              <i class="pi pi-eye"></i>
              <span>Ver perfil</span>
            </button>
            <button
              class="remove-friend-button"
              (click)="removeFriend(friend)">
              <i class="pi pi-trash"></i>
              <span>Eliminar</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- No Friends State -->
    <div *ngIf="friends.length === 0" class="empty-state">
      <div class="empty-icon">
        <i class="pi pi-heart"></i>
      </div>
      <h3>Aún no tienes amigos</h3>
      <p>Ve a la pestaña "Descubrir Usuarios" para encontrar compañeros de estudio</p>
      <p-button
        label="Descubrir usuarios"
        icon="pi pi-search"
        class="p-button-primary"
        (click)="setActiveTab('discover')">
      </p-button>
    </div>
  </div>

  <!-- User Profile Modal -->
  <p-dialog
    [(visible)]="showUserProfile"
    [modal]="true"
    [style]="{width: '600px'}"
    [closable]="true"
    [dismissableMask]="true"
    header="Perfil de Usuario"
    class="user-profile-dialog">

    <div *ngIf="selectedUser" class="profile-content">
      <!-- Profile Header -->
      <div class="profile-header">
        <div class="profile-avatar-section">
          <p-avatar
            [image]="selectedUser.avatar"
            size="xlarge"
            shape="circle"
            styleClass="profile-avatar">
          </p-avatar>
        </div>

        <div class="profile-basic-info">
          <h2>{{ selectedUser.name }}</h2>
          <p class="profile-username">@{{ selectedUser.username }}</p>

          <div class="profile-status-indicator" [class]="selectedUser.isOnline ? 'online' : 'offline'">
            <div class="status-dot">
              <i [class]="selectedUser.isOnline ? 'pi pi-circle-fill' : 'pi pi-circle'"></i>
            </div>
            <div class="status-text">
              <span>{{ selectedUser.isOnline ? 'En línea' : 'Desconectado' }}</span>
              <small *ngIf="!selectedUser.isOnline">{{ getLastSeenText(selectedUser) }}</small>
            </div>
          </div>

          <div class="profile-level" [style.color]="getUserLevelColor(selectedUser.level)">
            <i class="pi pi-star-fill"></i>
            <span>Nivel {{ selectedUser.level }} - {{ getUserLevelLabel(selectedUser.level) }}</span>
          </div>
        </div>
      </div>

      <!-- Profile Stats -->
      <div class="profile-stats">
        <div class="stat-card">
          <div class="stat-value">{{ selectedUser.experience }}</div>
          <div class="stat-label">Experiencia</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ selectedUser.achievements }}</div>
          <div class="stat-label">Logros</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ selectedUser.coursesCompleted }}</div>
          <div class="stat-label">Cursos Completados</div>
        </div>
      </div>

      <!-- Profile Details -->
      <div class="profile-details">
        <div *ngIf="selectedUser.bio" class="detail-section">
          <h4><i class="pi pi-info-circle"></i> Biografía</h4>
          <p>{{ selectedUser.bio }}</p>
        </div>

        <div *ngIf="selectedUser.location" class="detail-section">
          <h4><i class="pi pi-map-marker"></i> Ubicación</h4>
          <p>{{ selectedUser.location }}</p>
        </div>

        <div class="detail-section">
          <h4><i class="pi pi-calendar"></i> Miembro desde</h4>
          <p>{{ formatDate(selectedUser.joinDate) }}</p>
        </div>

        <div class="detail-section">
          <h4><i class="pi pi-users"></i> Estado de amistad</h4>
          <p class="friendship-status" [class]="selectedUser.friendStatus">
            {{ selectedUser.friendStatus === 'accepted' ? 'Amigos' :
               selectedUser.friendStatus === 'pending' ? 'Solicitud pendiente' :
               selectedUser.friendStatus === 'blocked' ? 'Bloqueado' : 'No conectado' }}
          </p>
        </div>
      </div>

      <!-- Profile Actions -->
      <div class="profile-actions">
        <p-button
          *ngIf="selectedUser.friendStatus === 'none'"
          label="Enviar solicitud de amistad"
          icon="pi pi-user-plus"
          class="p-button-primary"
          (click)="sendFriendRequest(selectedUser); closeUserProfile()">
        </p-button>
        <p-button
          *ngIf="selectedUser.friendStatus === 'pending'"
          label="Solicitud enviada"
          icon="pi pi-clock"
          class="p-button-secondary"
          disabled="true">
        </p-button>
        <p-button
          *ngIf="selectedUser.friendStatus === 'accepted'"
          label="Ya son amigos"
          icon="pi pi-heart"
          class="p-button-success"
          disabled="true">
        </p-button>
      </div>
    </div>
  </p-dialog>

  <!-- Confirm Dialog -->
  <p-confirmDialog></p-confirmDialog>

  <!-- Toast Messages -->
  <p-toast></p-toast>
</div>
